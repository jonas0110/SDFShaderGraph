{"code":"!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,\"a\",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p=\"\",n(n.s=0)}([function(t,e,n){n(1),n(2),n(3),t.exports=n(4)},function(t,e,n){var o={NODE_TITLE_HEIGHT:16,NODE_SLOT_HEIGHT:15,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,CANVAS_GRID_SIZE:10,NODE_TITLE_COLOR:\"#222\",NODE_DEFAULT_COLOR:\"#999\",NODE_DEFAULT_BGCOLOR:\"#444\",NODE_DEFAULT_BOXCOLOR:\"#AEF\",NODE_SELECTED_COLOR:\"#FFF\",NODE_DEFAULT_SHAPE:\"box\",MAX_NUMBER_OF_NODES:5e3,DEFAULT_POSITION:[100,100],node_images_path:\"\",proxy:null,debug:!1,throw_errors:!0,showcode:!1,registered_node_types:{},graph_max_steps:0,CANVAS_WEBGL:1,CANVAS_2D:2,current_ctx:0,COLOR_MAP:0,NORMAL_MAP:1,TANGENT_MAP:2,SPECULAR_MAP:3,BUMP_MAP:4,registerNodeType:function(t,e){if(!e.prototype)throw\"Cannot register a simple object, it must be a class with a prototype\";e.type=t,o.debug&&console.log(\"Node registered: \"+t);t.split(\"/\");var n=t.lastIndexOf(\"/\");if(e.category=t.substr(0,n),e.prototype)for(var i in a.prototype)e.prototype[i]||(e.prototype[i]=a.prototype[i]);this.registered_node_types[t]=e},createSubGraph:function(t,e){var n=new nodeSubGraph(t,e);return console.log(\"subGraph:\",n),n},createNode:function(t,e,n){var i=this.registered_node_types[t];if(!i)return o.debug&&console.log('GraphNode type \"'+t+'\" not registered.'),null;i.prototype;var s=new i(e=e||i.title||t);if(s.type=t,s.title||(s.title=e),s.properties||(s.properties={}),s.options||(s.options={}),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=o.DEFAULT_POSITION.concat()),s.shader_piece||(s.shader_piece=null),s.codes||(s.codes=[]),s.node_path||(s.node_path=[]),s.T_in_types||(s.T_in_types={}),s.T_out_types||(s.T_out_types={}),s.in_using_T||(s.in_using_T=0),s.in_conected_using_T||(s.in_conected_using_T=0),s.extraproperties)for(var r in s.extraproperties)s.properties[r]=s.extraproperties[r];if(n)for(var r in n)s[r]=n[r];return s.inputs&&(this.graph_max_steps+=s.inputs.length),s.addBasicProperties(),s},extendNodeTypeProperties:function(t,e,n){if(!t.prototype)throw\"Cannot register a simple object, it must be a class with a prototype\";t.prototype.extraproperties=t.prototype.extraproperties||{},t.prototype.extraproperties[e]=n},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t){var e=[];for(var n in this.registered_node_types)\"\"==t?null==this.registered_node_types[n].category&&e.push(this.registered_node_types[n]):this.registered_node_types[n].category==t&&e.push(this.registered_node_types[n]);return e},getNodeTypesCategories:function(){var t={\"\":1};for(var e in this.registered_node_types)this.registered_node_types[e].category&&!this.registered_node_types[e].skip_list&&(t[this.registered_node_types[e].category]=1);var n=[];for(var e in t)\"core\"!=e&&n.push(e);return n},reloadNodes:function(t){var e=document.getElementsByTagName(\"script\"),n=[];for(var i in e)n.push(e[i]);var s=document.getElementsByTagName(\"head\")[0];for(var i in t=document.location.href+t,n){var r=n[i].src;if(r&&r.substr(0,t.length)==t)try{o.debug&&console.log(\"Reloading: \"+r);var a=document.createElement(\"script\");a.type=\"text/javascript\",a.src=r,s.appendChild(a),s.removeChild(n[i])}catch(t){if(o.throw_errors)throw t;o.debug&&console.log(\"Error while reloading \"+r)}}o.debug&&console.log(\"Nodes reloaded\")},cloneObject:function(t,e){if(null==t)return null;var n=JSON.parse(JSON.stringify(t));if(!e)return n;for(var o in n)e[o]=n[o];return e}};function i(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function s(t,e,n,o,i,s){return n<t&&n+i>t&&o<e&&o+s>e}function r(){o.debug&&console.log(\"Graph created\"),this.list_of_graphcanvas=null,this.clear()}function a(t){this._ctor()}function p(t,e,n){if(\"string\"==typeof t&&(t=document.querySelector(t)),!t)throw\"no canvas found\";this.max_zoom=10,this.min_zoom=.1,e&&e.attachCanvas(this),this.setCanvas(t),this.clear(),n||this.startRendering()}function h(){console.log(\"add subgraph prefab\")}function u(t){this.header={},this.body_hash={},this.includes={},this.scope=\"\",this.order=void 0!==t?t:Number.MAX_VALUE,this.order-=u.ORDER_MODIFIER}function l(t,e,n){this.vertex=t||new u,this.fragment=e||new u,this.output_var=n||\"\"}\"undefined\"!=typeof performance?o.getTime=function(){return performance.now()}:o.getTime=function(){return Date.now()},CanvasRenderingContext2D.prototype.roundRect=function(t,e,n,o,i,s){return void 0===s||i===s?(n<2*i&&(i=n/2),o<2*i&&(i=o/2),this.beginPath(),this.moveTo(t+i,e),this.arcTo(t+n,e,t+n,e+o,i),this.arcTo(t+n,e+o,t,e+o,i),this.arcTo(t,e+o,t,e,i),this.arcTo(t,e,t+n,e,i),this.closePath(),this):(void 0===i&&(i=5),void 0===s&&(s=i),this.beginPath(),this.moveTo(t+i,e),this.lineTo(t+n-i,e),this.quadraticCurveTo(t+n,e,t+n,e+i),this.lineTo(t+n,e+o-s),this.quadraticCurveTo(t+n,e+o,t+n-s,e+o),this.lineTo(t+s,e+o),this.quadraticCurveTo(t,e+o,t,e+o-s),this.lineTo(t,e+i),this.quadraticCurveTo(t,e,t+i,e),this)},o.createContextualMenu=function(t,e,n){e=e||{},this.options=e,n=n||window,e.from||o.closeAllContextualMenus();var i=n.document.createElement(\"div\");i.className=\"litecontextualmenu litemenubar-panel\",this.root=i;var s=i.style;for(var r in s.minWidth=\"100px\",s.minHeight=\"20px\",s.position=\"fixed\",s.top=\"100px\",s.left=\"100px\",s.color=\"#AAF\",s.padding=\"2px\",s.borderBottom=\"2px solid #AAF\",s.backgroundColor=\"#444\",i.addEventListener(\"contextmenu\",(function(t){return t.preventDefault(),!1})),t){var a=t[r],p=n.document.createElement(\"div\");p.className=\"litemenu-entry\",null!=a?(a.is_menu&&(p.className+=\" submenu\"),a.disabled&&(p.className+=\" disabled\"),p.style.cursor=\"pointer\",p.dataset.value=\"string\"==typeof a?a:a.value,p.data=a,p.innerHTML=\"string\"==typeof a?t.constructor==Array?t[r]:r:a.content?a.content:r,p.addEventListener(\"click\",g),i.appendChild(p)):(p.className=\"litemenu-entry separator\",i.appendChild(p))}i.addEventListener(\"mouseover\",(function(t){this.mouse_inside=!0})),i.addEventListener(\"mouseout\",(function(t){var e=t.toElement;if(null!=e){for(;e!=this&&e!=n.document;)e=e.parentNode;if(e==this)return}this.mouse_inside=!1,this.block_close||this.closeMenu()})),n.document.body.appendChild(i);var h=i.getClientRects()[0];e.from&&(e.from.block_close=!0);var u=e.left||0,l=e.top||0;if(e.event){u=e.event.pageX-10,l=e.event.pageY-10,e.left&&(u=e.left);var d=n.document.body.getClientRects()[0];if(e.from){var c=e.from.getClientRects()[0];u=c.left+c.width}u>d.width-h.width-10&&(u=d.width-h.width-10),l>d.height-h.height-10&&(l=d.height-h.height-10)}function g(t){this.dataset.value;var n=!0;if(e.callback){var s=e.callback.call(i,this.data,t);null!=s&&(n=s)}n&&o.closeAllContextualMenus()}return i.style.left=u+\"px\",i.style.top=l+\"px\",i.closeMenu=function(){e.from&&(e.from.block_close=!1,e.from.mouse_inside||e.from.closeMenu()),this.parentNode&&n.document.body.removeChild(this)},i},o.closeAllContextualMenus=function(){var t=document.querySelectorAll(\".litecontextualmenu\");if(t.length){for(var e=[],n=0;n<t.length;n++)e.push(t[n]);for(var n in e)e[n].parentNode&&e[n].parentNode.removeChild(e[n])}},o.extendClass=function(t,e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);if(e.prototype)for(var n in e.prototype)e.prototype.hasOwnProperty(n)&&(t.prototype.hasOwnProperty(n)||(e.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,e.prototype.__lookupGetter__(n)):t.prototype[n]=e.prototype[n],e.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,e.prototype.__lookupSetter__(n))))},o.compareNodeTypes=function(t,e){var n=Object.keys(t.types).length?t.types:t.types_list,o=Object.keys(e.types).length?e.types:e.types_list;if(!n||!o)return!1;for(key in n)if(o.hasOwnProperty(key))return!0;return!1},o.dispatchEvent=function(t,e,n){var o;document.createEvent?(o=document.createEvent(\"HTMLEvents\")).initEvent(t,!0,!0):(o=document.createEventObject()).eventType=t,o.eventName=t,o.data=e,n||(n=document),document.createEvent?n.dispatchEvent(o):n.fireEvent(\"on\"+o.eventType,o)},o.removeExtension=function(t){return t.split(\".\")[0]},o.hexToColor=function(t,e){var n,o=(n=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(t))?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]:null;return e?[(o[0]/255).toFixed(3),(o[1]/255).toFixed(3),(o[2]/255).toFixed(3),1]:\"vec4(\"+(o[0]/255).toFixed(3)+\",\"+(o[1]/255).toFixed(3)+\",\"+(o[2]/255).toFixed(3)+\", 1.0)\"},o.getOtputTypeFromMap=function(t){for(var e in t)if(\"float\"!=e)return e;return\"float\"},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}),r.supported_types=[\"number\",\"string\",\"boolean\"],r.prototype.getSupportedTypes=function(){return this.supported_types||r.supported_types},r.STATUS_STOPPED=1,r.STATUS_RUNNING=2,r.prototype.clear=function(){this.stop(),this.status=r.STATUS_STOPPED,this.last_node_id=0,this._nodes=[],this._subGraphs=[],this._nodes_by_id={},this._nodes_in_order=[],this.globals={},this.last_link_id=1,this.links={},this.iteration=0,this.config={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.starttime=0,this.global_inputs={},this.global_outputs={},this.debug=!0,this.configuring=!1,this.shader_output=null,o.graph_max_steps=0,this.change(),this.sendActionToCanvas(\"clear\")},r.prototype.attachCanvas=function(t){if(t.constructor!=p)throw\"attachCanvas expects a LGraphCanvas instance\";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},r.prototype.detachCanvas=function(t){var e=this.list_of_graphcanvas.indexOf(t);-1!=e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))},r.prototype.start=function(t){if(this.status!=r.STATUS_RUNNING){this.status=r.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes(\"onStart\"),this.starttime=o.getTime(),t=t||1;var e=this;this.execution_timer_id=setInterval((function(){e.runStep(1)}),t)}},r.prototype.stop=function(){this.status!=r.STATUS_STOPPED&&(this.status=r.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null,this.sendEventToAllNodes(\"onStop\"))},r.prototype.runStep=function(t){t=t||1;var e=o.getTime();this.globaltime=.001*(e-this.starttime);try{for(var n=0;n<t;n++)this.sendEventToAllNodes(\"onExecute\"),this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep();this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(t){if(this.errors_in_execution=!0,o.throw_errors)throw t;o.debug&&console.log(\"Error during execution: \"+t),this.stop()}var i=o.getTime()-e;0==i&&(i=1),this.elapsed_time=.001*i,this.globaltime+=.001*i,this.iteration+=1},r.prototype.updateExecutionOrder=function(){this.removing||(o.BFS?this._nodes_in_order=this.computeExecutionBFS():this._nodes_in_order=this.computeExecutionOrder(),this.checkLinksIntegrity(),o.dispatchEvent(\"contentChange\",null,null))},r.prototype.checkLinksIntegrity=function(){for(var t in this._nodes_in_order){var e=this._nodes_in_order[t];e.in_conected_using_T>0&&(e.in_conected_using_T=0,e.resetTypes());for(var n=0;null!=e.inputs&&n<e.inputs.length;n++)if(e.inputs[n].use_t){var o=e.inputs[n].link;if(!o)continue;if(s=this.links[o]){var i=this.getNodeById(s.origin_id);e.infereTypes(i.outputs[s.origin_slot],s.target_slot,i)}}}for(var n in this.links){var s=this.links[n],r=(i=this.getNodeById(s.origin_id),this.getNodeById(s.target_id));r&&i&&!r.compareNodeTypes(i,i.outputs[s.origin_slot],s.target_slot)?s.color=\"#FF0000\":s.color=null}},r.prototype.computeExecutionBFS=function(){for(var t={},e={},n=[this.findNodesByType(\"core/Output\")[0]],o=0;n.length>0;){if(e[(d=n.shift()).id]=o++,d.inputs)for(var i=0;i<d.inputs.length;i++){var s=d.inputs[i];if(null!=s&&null!=s.link){var r=s.link,a=this.links[r];if(a){var p=this.getNodeById(a.origin_id);null!=p?(t[a.id]=!0,n.push(p)):t[a.id]=!0}}}}var h=[];for(var u in e)h.push([this.getNodeById(u),e[u]]);h.sort((function(t,e){return t[1]-e[1]}));n=[];var l=h.length;for(o=l-1;o>=0;--o){var d;(d=h[o][0]).order=l-o,n.push(d),d.processNodePath()}return n},r.prototype.computeExecutionOrderTopological=function(){var t=[],e=[],n={},i={},s={},r=this.findNodesByType(\"core/Output\")[0];for(var a in this._nodes){n[(l=this._nodes[a]).id]=l;var p=0;if(l.outputs)for(var h=0,u=l.outputs.length;h<u;h++)l.outputs[h]&&null!=l.outputs[h].links&&l.outputs[h].links.length>0&&(p+=l.outputs[h].links.length);0==p?e.push(l):s[l.id]=p}e.push(r);for(;0!=e.length;){var l=e.shift();if(t.unshift(l),delete n[l.id],l.inputs)for(a=0;a<l.inputs.length;a++){var d=l.inputs[a];if(null!=d&&null!=d.link){var c=d.link,g=this.links[c];if(g&&!i[g.id]){var f=this.getNodeById(g.origin_id);null!=f?(i[g.id]=!0,s[f.id]-=1,0==s[f.id]&&e.push(f)):i[g.id]=!0}}}}for(var a in n)t.unshift(n[a]);for(var a in t.length!=this._nodes.length&&o.debug&&console.log(\"something went wrong, nodes missing\"),t)t[a].order=parseInt(a),t[a].processNodePath();return t},r.prototype.computeExecutionOrder=function(){var t=[],e=[],n={},i={},s={};for(var r in this._nodes){n[(u=this._nodes[r]).id]=u;var a=0;if(u.inputs)for(var p=0,h=u.inputs.length;p<h;p++)u.inputs[p]&&null!=u.inputs[p].link&&(a+=1);0==a?e.push(u):s[u.id]=a}for(;0!=e.length;){var u=e.shift();if(t.push(u),delete n[u.id],u.outputs)for(r=0;r<u.outputs.length;r++){var l=u.outputs[r];if(null!=l&&null!=l.links&&0!=l.links.length)for(p=0;p<l.links.length;p++){var d=l.links[p],c=this.links[d];if(c&&!i[c.id]){var g=this.getNodeById(c.target_id);null!=g?(i[c.id]=!0,s[g.id]-=1,0==s[g.id]&&e.push(g)):i[c.id]=!0}}}}for(var r in n)t.push(n[r]);for(var r in t.length!=this._nodes.length&&o.debug&&console.log(\"something went wrong, nodes missing\"),t)t[r].order=parseInt(r),t[r].processNodePath();return t},r.prototype.getTime=function(){return this.globaltime},r.prototype.getFixedTime=function(){return this.fixedtime},r.prototype.getElapsedTime=function(){return this.elapsed_time},r.prototype.sendEventToAllNodes=function(t,e){var n=this._nodes_in_order?this._nodes_in_order:this._nodes;for(var o in n)n[o][t]&&n[o][t](e)},r.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var n in this.list_of_graphcanvas){var o=this.list_of_graphcanvas[n];o[t]&&o[t].apply(o,e)}},r.prototype.add=function(t,e){if(t&&(-1==t.id||null==this._nodes_by_id[t.id])){if(this._nodes.length>=o.MAX_NUMBER_OF_NODES)throw\"LiteGraph: max number of nodes in a graph reached\";return null!=t.id&&-1!=t.id||(t.id=this.last_node_id++,console.log(\"rearange node id in new subGraph:\",t.id)),t.graph=this,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.configuring||this.change(),t}},r.prototype.removeSubGraph=function(t){var e=this._subGraphs.indexOf(t);-1!=e&&this._subGraphs.splice(e,1),delete t,this.setDirtyCanvas(!0,!0),this.change()},r.prototype.remove=function(t){if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(t.inputs){for(var e=0;e<t.inputs.length;e++){null!=(n=t.inputs[e]).link&&t.disconnectInput(e)}o.graph_max_steps-=t.inputs.length}if(t.outputs)for(e=0;e<t.outputs.length;e++){var n;null!=(n=t.outputs[e]).links&&n.links.length&&t.disconnectOutput(e)}for(var e in this.onNodeRemove&&this.onNodeRemove(t),t.onRemoved&&t.onRemoved(),t.id=-1,t.graph=null,this.list_of_graphcanvas){var i=this.list_of_graphcanvas[e];i.selected_nodes[t.id]&&delete i.selected_nodes[t.id],i.node_dragged==t&&(i.node_dragged=null)}var s=this._nodes.indexOf(t);-1!=s&&this._nodes.splice(s,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}},r.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},r.prototype.findNodesByType=function(t){var e=[];for(var n in this._nodes)this._nodes[n].type==t&&e.push(this._nodes[n]);return e},r.prototype.findNodesByTitle=function(t){var e=[];for(var n in this._nodes)this._nodes[n].title==t&&e.push(this._nodes[n]);return e},r.prototype.getNodeOnPos=function(t,e,n){for(var o=(n=n||this._nodes).length-1;o>=0;o--){var i=n[o];if(i.isPointInsideNode(t,e))return i}return null},r.prototype.getSubGraphOnPos=function(t,e,n){n=n||this._nodes;for(var o=this.graph&&this.graph.isLive()?0:20,i=n.length-1;i>=0;i--){var s=n[i];if(s.rect.pos[0]-4<t&&s.rect.pos[0]+s.rect.size[0]+4>t&&s.rect.pos[1]-o<e&&s.rect.pos[1]+s.rect.size[1]>e)return s}return null},r.prototype.addGlobalInput=function(t,e,n){this.global_inputs[t]={name:t,type:e,value:n},this.onGlobalInputAdded&&this.onGlobalInputAdded(t,e),this.onGlobalsChange&&this.onGlobalsChange()},r.prototype.setGlobalInputData=function(t,e){var n=this.global_inputs[t];n&&(n.value=e)},r.prototype.getGlobalInputData=function(t){var e=this.global_inputs[t];return e?e.value:null},r.prototype.renameGlobalInput=function(t,e){if(e!=t){if(!this.global_inputs[t])return!1;if(this.global_inputs[e])return console.error(\"there is already one input with that name\"),!1;this.global_inputs[e]=this.global_inputs[t],delete this.global_inputs[t],this.onGlobalInputRenamed&&this.onGlobalInputRenamed(t,e),this.onGlobalsChange&&this.onGlobalsChange()}},r.prototype.changeGlobalInputType=function(t,e){if(!this.global_inputs[t])return!1;this.global_inputs[t].type!=e&&(this.global_inputs[t].type=e,this.onGlobalInputTypeChanged&&this.onGlobalInputTypeChanged(t,e))},r.prototype.removeGlobalInput=function(t){return!!this.global_inputs[t]&&(delete this.global_inputs[t],this.onGlobalInputRemoved&&this.onGlobalInputRemoved(t),this.onGlobalsChange&&this.onGlobalsChange(),!0)},r.prototype.addGlobalOutput=function(t,e,n){this.global_outputs[t]={name:t,type:e,value:n},this.onGlobalOutputAdded&&this.onGlobalOutputAdded(t,e),this.onGlobalsChange&&this.onGlobalsChange()},r.prototype.setGlobalOutputData=function(t,e){var n=this.global_outputs[t];n&&(n.value=e)},r.prototype.getGlobalOutputData=function(t){var e=this.global_outputs[t];return e?e.value:null},r.prototype.renameGlobalOutput=function(t,e){return!!this.global_outputs[t]&&(this.global_outputs[e]?(console.error(\"there is already one output with that name\"),!1):(this.global_outputs[e]=this.global_outputs[t],delete this.global_outputs[t],this.onGlobalOutputRenamed&&this.onGlobalOutputRenamed(t,e),void(this.onGlobalsChange&&this.onGlobalsChange())))},r.prototype.changeGlobalOutputType=function(t,e){if(!this.global_outputs[t])return!1;this.global_outputs[t].type!=e&&(this.global_outputs[t].type=e,this.onGlobalOutputTypeChanged&&this.onGlobalOutputTypeChanged(t,e))},r.prototype.removeGlobalOutput=function(t){return!!this.global_outputs[t]&&(delete this.global_outputs[t],this.onGlobalOutputRemoved&&this.onGlobalOutputRemoved(t),this.onGlobalsChange&&this.onGlobalsChange(),!0)},r.prototype.setInputData=function(t,e){var n=this.findNodesByName(t);for(var o in n)n[o].setValue(e)},r.prototype.getOutputData=function(t){return this.findNodesByName(t).length?m[0].getValue():null},r.prototype.triggerInput=function(t,e){var n=this.findNodesByName(t);for(var o in n)n[o].onTrigger(e)},r.prototype.setCallback=function(t,e){var n=this.findNodesByName(t);for(var o in n)n[o].setTrigger(e)},r.prototype.onConnectionChange=function(){this.updateExecutionOrder()},r.prototype.isLive=function(){for(var t in this.list_of_graphcanvas){if(this.list_of_graphcanvas[t].live_mode)return!0}return!1},r.prototype.change=function(){o.debug&&console.log(\"Graph changed\"),this.sendActionToCanvas(\"setDirty\",[!0,!0]),this.on_change&&this.on_change(this)},r.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas(\"setDirty\",[t,e])},r.prototype.serialize=function(){var t=[];for(var e in this._nodes)t.push(this._nodes[e].serialize());for(var e in this._subGraphs)t.push(this._subGraphs[e].serialize());for(var e in this.links)this.links[e].data=null;return console.log(\"nodes_info:\",t),{shader_textures:this.shader_textures,iteration:this.iteration,frame:this.frame,last_node_id:this.last_node_id,last_link_id:this.last_link_id,links:o.cloneObject(this.links),config:this.config,nodes:t}},r.prototype.serializeSubGraph=function(){var t=[];_subgraph=null;var e=this.list_of_graphcanvas[0];for(var n in console.log(e.selected_nodes),e.selected_nodes){var i=e.selected_nodes[n];\"subGraph\"==i.type&&(_subgraph=i,console.log(\"serializing subgraph:\",i),t.push(i.serialize()))}if(_subgraph){for(var n in console.log(_subgraph),_subgraph.links)_subgraph.links[n].data=null;var s={links:o.cloneObject(_subgraph.links),nodes:t};return console.log(\"subgraph data for serialize:\",s),s}return null},r.prototype.loadFromURL=function(t,e,n,o){var i=this;HttpRequest(t,null,(function(t){var o=JSON.parse(t);e&&e(o),i.configure(o),n&&n(o)}),(function(t){n&&n(null)}))},r.prototype.addGraph=function(t,e,n){console.log(\"add graph to pos:\",n);var i=t.nodes[0].name,s=t.nodes[0].nodes,r=t.links,a=!1,p=[],h=[],u=[];for(var l in s){var d=s[l],c=o.createNode(d.type,d.title);if(console.log(\"add node from subgraph file:\",d),c){for(var g of(c.configure(d),c.id=d.id,c.id=-1,c.pos=d.pos,c=this.add(c,!1),p.push({newid:c.id,oldid:d.id}),console.log(\"new node id:\",c.id),u.push(c),r)){for(var f of(console.log(\"per link:\",g),Object.keys(g)))for(var _ of p)g[f]==_.oldid&&(g[f]=_.newid);this.last_link_id++,h.push({oldid:g.id,newid:this.last_link_id}),g.id=this.last_link_id,this.links[this.last_link_id]=g}for(var v of(console.log(\"node.inputs\",c.inputs),Object.keys(c.inputs))){var y=!1;for(var _ of h)c.inputs[v].link==_.oldid&&(c.inputs[v].link=_.newid,console.log(\"changed\",_),y=!0);y||(c.inputs[v].link=null)}for(var m in console.log(\"node.inputs after\",c.inputs),console.log(\"node.outputs\",c.outputs),c.outputs){var b=[];for(var C in c.outputs[m].links)for(var _ of h)c.outputs[m].links[C]==_.oldid&&console.log(\"changed\",_),b.push(_.newid);c.outputs[m].links=b}console.log(\"node.outputs after\",c.outputs)}else o.debug&&console.log(\"Node not found: \"+d.type),a=!0}var O=new nodeSubGraph(u,this);for(var c of(O.properties.name=i,console.log(\"add new subgraph:\",O),Object.values(O.nodes)))console.log(\"node:\",c),c.pos[0]+=n[0]-O.rect.pos[0],c.pos[1]+=n[1]-O.rect.pos[1];return this._subGraphs.push(O),this.updateExecutionOrder(),this.setDirtyCanvas(!0,!0),this.change(),a},r.prototype.configure=function(t,e){console.log(\"config:\",t),e||(console.log(\"clear graph\"),this.clear()),this.configuring=!0;var n=t.nodes;for(var i in t)\"nodes\"!=i&&(this[i]=t[i]);var s=!1;for(var i in this._nodes=[],this._subGraphs=[],n){var r=n[i];if(\"subGraph\"!=r.type){if(!(p=o.createNode(r.type,r.title))){o.debug&&console.log(\"Node not found: \"+r.type),s=!0;continue}p.id=r.id,this.add(p,!0),p.configure(r)}else{var a=[];for(var p of n[i].nodes)for(var h of this._nodes)h.id==p.id&&a.push(h);var u=new nodeSubGraph(a,this);u.properties.name=r.name,this._subGraphs.push(u)}}return this.configuring=!1,this.updateExecutionOrder(),this.setDirtyCanvas(!0,!0),this.change(),s},r.prototype.onNodeTrace=function(t,e,n){},a.prototype._ctor=function(t){this.title=t||\"Unnamed\",this.title_width=o.NODE_MIN_WIDTH,this.size=[o.NODE_WIDTH,60],this.graph=null,this.pos=[10,10],this.id=-1,this.types=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.options={},this.addBasicProperties(),this.data=null,this.flags={},this.shader_piece=null,this.codes=[],this.node_path=[],this.T_in_types={},this.T_out_types={},this.in_using_T=0,this.in_conected_using_T=0},a.prototype.addBasicProperties=function(){this.properties.is_global=!1,this.properties.global_name=this.title,this.options=this.options||{},this.options.is_global=this.options.is_global||{},this.options.is_global.reloadonchange=1,this.options.is_global.callback=\"callbackIsGlobal\",this.options.is_global.hidden=!this.options.is_global.hasOwnProperty(\"hidden\")||this.options.is_global.hidden,this.options.global_name={hidden:!this.properties.is_global}},a.prototype.callbackIsGlobal=function(){this.setGlobalColor(),this.options.global_name.hidden=!this.options.global_name.hidden},a.prototype.configure=function(t){for(var e in t)if(\"console\"!=e)if(\"properties\"!=e)if(\"options\"!=e)null!=t[e]&&(\"object\"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=o.cloneObject(t[e],this[e]):this[e]=t[e]);else for(var n in t.options)this.options[n]=t.options[n];else for(var n in t.properties)this.properties[n]=t.properties[n];for(var i in this.inputs){console.log(\"load inputs:\",this.inputs);var s=this.inputs[i];if(s.link&&s.link.length)\"object\"==typeof(a=s.link)&&(s.link=a[0],this.graph.links[a[0]]={id:a[0],origin_id:a[1],origin_slot:a[2],target_id:a[3],target_slot:a[4]})}for(var i in console.log(\"load outputs:\",this.outputs),this.outputs){var r=this.outputs[i];if(r.links&&0!=r.links.length)for(var e in r.links){var a;\"object\"==typeof(a=r.links[e])&&(r.links[e]=a[0])}}},a.prototype.serialize=function(){var t={id:this.id,title:this.title,type:this.type,pos:this.pos,size:this.size,data:this.data,flags:o.cloneObject(this.flags),inputs:o.cloneObject(this.inputs),outputs:o.cloneObject(this.outputs),shader_piece:this.shader_piece,codes:this.codes,T_out_types:this.T_out_types,T_in_types:this.T_in_types,in_conected_using_T:this.in_conected_using_T};return this.properties&&(t.properties=o.cloneObject(this.properties)),this.options&&(t.options=o.cloneObject(this.options)),t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t),t},a.prototype.clone=function(){var t=o.createNode(this.type),e=this.serialize();for(var n in delete e.id,t.configure(e),e.inputs){var i=t.inputs[n].link,s=this.graph.links[i];if(s){var r=this.graph.last_link_id++;t.inputs[n].link=r,this.graph.links[r]={id:r,origin_id:s.origin_id,origin_slot:s.origin_slot,target_id:s.target_id,target_slot:s.target_slot}}}for(var n in e.outputs){e.outputs[n].links;t.outputs[n].links=[]}return t.properties.is_global=!1,t},a.prototype.toString=function(){return JSON.stringify(this.serialize())},a.prototype.getTitle=function(){return this.title||this.constructor.title},a.prototype.getTitleWidth=function(t,e){return this.title_width},a.prototype.computeTitleWidth=function(t,e){return t.font=e,this.title_width=this.title?t.measureText(this.title).width+o.NODE_TITLE_HEIGHT+5:0,this.size[0]<this.title_width&&(this.size[0]=this.title_width),this.title_width},a.prototype.setOutputData=function(t,e){if(this.outputs&&t>-1&&t<this.outputs.length&&this.outputs[t]&&null!=this.outputs[t].links)for(var n=0;n<this.outputs[t].links.length;n++){var o=this.outputs[t].links[n];this.graph.links[o].data=e}},a.prototype.getInputData=function(t){return this.inputs&&t<this.inputs.length&&null!=this.inputs[t].link?this.graph.links[this.inputs[t].link].data:null},a.prototype.isInputConnected=function(t){return this.inputs?t<this.inputs.length&&null!=this.inputs[t].link:null},a.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},a.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},a.prototype.isOutputConnected=function(t){return this.outputs?t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length:null},a.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t<this.outputs.length){for(var e=this.outputs[t],n=[],o=0;o<e.length;o++)n.push(this.graph.getNodeById(e.links[o].target_id));return n}return null},a.prototype.triggerOutput=function(t,e){var n=this.getOutputNode(t);n&&n.onTrigger&&n.onTrigger(e)},a.prototype.addOutput=function(t,e,n,o){var i={name:t,type:e,types:n=n||{},links:null};if(o)for(var s in o)i[s]=o[s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),this.size=this.computeSize()},a.prototype.addOutputs=function(t){for(var e in t){var n=t[e],o={name:n[0],type:n[1],link:null};if(t[2])for(var i in n[2])o[i]=n[2][i];this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o)}this.size=this.computeSize()},a.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1),this.size=this.computeSize(),this.onOutputRemoved&&this.onOutputRemoved(t)},a.prototype.addInput=function(t,e,n,o){var i={name:t,type:e,link:null,types:n=n||{}};if(o){for(var s in o)i[s]=o[s];o.use_t&&this.in_using_T++}this.inputs||(this.inputs=[]),this.inputs.push(i),this.size=this.computeSize(),this.onInputAdded&&this.onInputAdded(i)},a.prototype.addInputs=function(t){for(var e in t){var n=t[e],o={name:n[0],type:n[1],link:null};if(t[2])for(var i in n[2])o[i]=n[2][i];this.inputs||(this.inputs=[]),this.inputs.push(o),this.onInputAdded&&this.onInputAdded(o)}this.size=this.computeSize()},a.prototype.removeInput=function(t){this.disconnectInput(t),this.inputs.splice(t,1),this.size=this.computeSize(),this.onInputRemoved&&this.onInputRemoved(t)},a.prototype.addConnection=function(t,e,n,o){this.connections.push({name:t,type:e,pos:n,direction:o,links:null})},a.prototype.computeSize=function(t){var e=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=new Float32Array([0,0]);return n[1]=14*e+6,this.inputs&&0!=this.inputs.length&&this.outputs&&0!=this.outputs.length?n[0]=o.NODE_WIDTH:n[0]=.5*o.NODE_WIDTH,n},a.prototype.getBounding=function(){return new Float32Array([this.pos[0]-4,this.pos[1]-o.NODE_TITLE_HEIGHT,this.pos[0]+this.size[0]+4,this.pos[1]+this.size[1]+r.NODE_TITLE_HEIGHT])},a.prototype.isPointInsideNode=function(t,e){var n=this.graph&&this.graph.isLive()?0:20;if(this.flags.collapsed){if(s(t,e,this.pos[0],this.pos[1]-o.NODE_TITLE_HEIGHT,this.getTitleWidth(),o.NODE_TITLE_HEIGHT))return!0}else if(this.pos[0]-4<t&&this.pos[0]+this.size[0]+4>t&&this.pos[1]-n<e&&this.pos[1]+this.size[1]>e)return!0;return!1},a.prototype.findInputSlot=function(t){if(!this.inputs)return-1;for(var e=0,n=this.inputs.length;e<n;++e)if(t==this.inputs[e].name)return e;return-1},a.prototype.findOutputSlot=function(t){if(!this.outputs)return-1;for(var e=0,n=this.outputs.length;e<n;++e)if(t==this.outputs[e].name)return e;return-1},a.prototype.connect=function(t,e,n){if(n=n||0,t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return o.debug&&console.log(\"Connect: Error, no slot of name \"+t),!1}else if(!this.outputs||t>=this.outputs.length)return o.debug&&console.log(\"Connect: Error, slot number not found\"),!1;if(e==this)return!1;if(n.constructor===String){if(-1==(n=e.findInputSlot(n)))return o.debug&&console.log(\"Connect: Error, no slot of name \"+n),!1}else if(!e.inputs||n>=e.inputs.length)return o.debug&&console.log(\"Connect: Error, slot number not found\"),!1;-1!=n&&null!=e.inputs[n].link&&e.disconnectInput(n);var i=this.outputs[t];if(-1==n)null==i.links&&(i.links=[]),i.links.push({id:e.id,slot:-1});else if(\"\"!=i.type&&\"\"!=e.inputs[n].type&&i.type==e.inputs[n].type||e.compareNodeTypes(this,i,n)){var s={id:this.graph.last_link_id++,origin_id:this.id,origin_slot:t,target_id:e.id,target_slot:n};this.graph.links[s.id]=s,null==i.links&&(i.links=[]),i.links.push(s.id),e.inputs[n].link=s.id,e.inputs[n].use_t&&e.infereTypes(i,n,this),this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange()}return e.onInputConnect&&e.onInputConnect(),!0},a.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return o.debug&&console.log(\"Connect: Error, no slot of name \"+t),!1}else if(!this.outputs||t>=this.outputs.length)return o.debug&&console.log(\"Connect: Error, slot number not found\"),!1;var n=this.outputs[t];if(!n.links||0==n.links.length)return!1;if(e)for(var i=0,s=n.links.length;i<s;i++){var r=n.links[i];if((p=this.graph.links[r]).target_id==e.id){n.links.splice(i,1),(a=e.inputs[p.target_slot]).link=null,a.use_t&&e.disconnectTemplateSlot(i),delete this.graph.links[r];break}}else{for(i=0,s=n.links.length;i<s;i++){r=n.links[i];var a,p=this.graph.links[r];if(e=this.graph.getNodeById(p.target_id))(a=e.inputs[p.target_slot]).link=null,a.use_t&&e.disconnectTemplateSlot(i)}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange(),!0},a.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return o.debug&&console.log(\"Connect: Error, no slot of name \"+t),!1}else if(!this.inputs||t>=this.inputs.length)return o.debug&&console.log(\"Connect: Error, slot number not found\"),!1;var e=this.inputs[t];if(!e)return!1;e.use_t&&this.disconnectTemplateSlot(t);var n=this.inputs[t].link;this.inputs[t].link=null;var i=this.graph.links[n],s=this.graph.getNodeById(i.origin_id);if(!s)return!1;var r=s.outputs[i.origin_slot];if(!r||!r.links||0==r.links.length)return!1;for(var a=0,p=r.links.length;a<p;a++){n=r.links[a];if((i=this.graph.links[n]).target_id==this.id){r.links.splice(a,1);break}}return this.onInputDisconnect&&this.onInputDisconnect(),this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange(),!0},a.prototype.getConnectionPos=function(t,e){return this.flags.collapsed?t?[this.pos[0],this.pos[1]-.5*o.NODE_TITLE_HEIGHT]:[this.pos[0]+this.getTitleWidth(),this.pos[1]-.5*o.NODE_TITLE_HEIGHT]:t&&-1==e?[this.pos[0]+10,this.pos[1]+10]:t&&this.inputs.length>e&&this.inputs[e].pos?[this.pos[0]+this.inputs[e].pos[0],this.pos[1]+this.inputs[e].pos[1]]:!t&&this.outputs.length>e&&this.outputs[e].pos?[this.pos[0]+this.outputs[e].pos[0],this.pos[1]+this.outputs[e].pos[1]]:t?[this.pos[0],this.pos[1]+10+e*o.NODE_SLOT_HEIGHT]:[this.pos[0]+this.size[0]+1,this.pos[1]+10+e*o.NODE_SLOT_HEIGHT]},a.prototype.alignToGrid=function(){this.pos[0]=o.CANVAS_GRID_SIZE*Math.round(this.pos[0]/o.CANVAS_GRID_SIZE),this.pos[1]=o.CANVAS_GRID_SIZE*Math.round(this.pos[1]/o.CANVAS_GRID_SIZE)},a.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>a.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace(this,t)},a.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas(\"setDirty\",[t,e])},a.prototype.loadImage=function(t){var e=new Image;e.src=o.node_images_path+t,e.ready=!1;var n=this;return e.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},e},a.prototype.executeAction=function(t){if(\"\"==t)return!1;if(-1!=t.indexOf(\";\")||-1!=t.indexOf(\"}\"))return this.trace(\"Error: Action contains unsafe characters\"),!1;var e=t.split(\"(\")[0];if(\"function\"!=typeof this[e])return this.trace(\"Error: Action not found on node: \"+e),!1;var n=t;try{var o=eval;eval=null,new Function(\"with(this) { \"+n+\"}\").call(this),eval=o}catch(e){return this.trace(\"Error executing action {\"+t+\"} :\"+e),!1}return!0},a.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas){var e=this.graph.list_of_graphcanvas;for(var n in e){var o=e[n];(t||o.node_capturing_input==this)&&(o.node_capturing_input=t?this:null,this.graph.debug&&console.log(this.title+\": Capturing input \"+(t?\"ON\":\"OFF\")))}}},a.prototype.collapse=function(){this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0)},a.prototype.pin=function(t){this.flags.pinned=void 0===t?!this.flags.pinned:t},a.prototype.localToScreen=function(t,e,n){return[(t+this.pos[0])*n.scale+n.offset[0],(e+this.pos[1])*n.scale+n.offset[1]]},a.prototype.getInputNodes=function(){var t=[];if(!this.inputs||0==this.inputs.length)return t;for(var e=0;e<this.inputs.length;e++){var n=this.inputs[e].link,o=this.graph.links[n];o&&(t[e]=this.graph.getNodeById(o.origin_id))}return t},a.prototype.getInputCode=function(t){var e=this.inputs[t].link,n=this.graph.links[e];return n?this.graph.getNodeById(n.origin_id).codes[n.origin_slot]:null},a.prototype.getInputNodePath=function(t){var e=this.inputs[t].link,n=this.graph.links[e];return n?this.graph.getNodeById(n.origin_id).node_path[n.origin_slot]:{}},a.prototype.getOutputNodePath=function(t){var e=this.outputs[t].link,n=this.graph.links[e];return n?this.graph.getNodeById(n.target_id).node_path[n.target_slot]:{}},a.prototype.insertIntoPath=function(t){t.hasOwnProperty(this.id)||(t[this.id]=this)},a.prototype.mergePaths=function(t,e){for(var n,o=Object.keys(e),i=0,s=o.length;i<s;i++)t[n=o[i]]=e[n]},a.prototype.processNodePath=function(){var t={};for(var e in this.inputs){var n=this.getInputNodePath(e);e>0?this.mergePaths(t,n):t=n}for(var e in this.insertIntoPath(t),this.outputs)this.node_path[e]=t},a.prototype.onGetNullCode=function(t){},a.prototype.infereTypes=function(t,e){if(this.in_conected_using_T++,this.inputs[e].use_t&&1==this.in_conected_using_T){var n=this.getTypesFromOutputSlot(t);for(var o in n)this.T_in_types[o]=n[o],this.T_out_types[o]=n[o]}},a.prototype.recomputeTypes=function(t,e){if(13!=this.id&&11!=this.id||console.log(\"hola\"),this.inputs[e].use_t&&1==this.in_conected_using_T){this.resetTypes(e);var n=this.getTypesFromOutputSlot(t);for(var o in n)this.T_in_types[o]=n[o],this.T_out_types[o]=n[o]}},a.prototype.resetTypes=function(t){if(!this.in_conected_using_T){for(var e in this.T_in_types)delete this.T_in_types[e];for(var e in this.T_out_types)delete this.T_out_types[e]}},a.prototype.compareNodeTypes=function(t,e,n){var o=this.inputs[n],i=null,s=null,r=!1;if(e.use_t&&(i=0==Object.keys(t.T_out_types)?null:t.T_out_types),null===i&&(i=Object.keys(e.types).length?e.types:e.types_list),o.use_t?(s=0==Object.keys(this.T_in_types)?null:this.T_in_types,r=!0):s=Object.keys(o.types).length?o.types:o.types_list,!i||!s)return r;for(key in i)if(s.hasOwnProperty(key))return!0;return!1},a.prototype.getTypesFromOutputSlot=function(t){var e=null;return t.use_t&&(e=0==Object.keys(this.T_out_types)?null:this.T_out_types),null===e&&(e=Object.keys(t.types).length?t.types:t.types_list),e},a.prototype.disconnectTemplateSlot=function(t){this.in_conected_using_T>0&&this.in_conected_using_T--,this.resetTypes(t)},a.prototype.connectTemplateSlot=function(){this.in_conected_using_T++},a.prototype.setGlobalColor=function(){this.properties.is_global?this.color=\"#AFA\":delete this.color},p.link_type_colors={number:\"#AAC\",node:\"#DCA\"},p.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.scale=1,this.offset=[0,0],this.selected_nodes={},this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highquality_render=!0,this.editor_alpha=1,this.pause_rendering=!1,this.render_shadows=!0,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.node_in_panel=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.title_text_font=\"bold 14px Arial\",this.inner_text_font=\"normal 12px Arial\",this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!0,this.connections_width=4,this.onClear&&this.onClear()},p.prototype.setGraph=function(t){this.graph!=t&&(this.clear(),t||!this.graph?(t.attachCanvas(this),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},p.prototype.openSubgraph=function(t){if(!t)throw\"graph cannot be null\";if(this.graph==t)throw\"graph cannot be the same\";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.setDirty(!0,!0)},p.prototype.closeSubgraph=function(){this._graph_stack&&0!=this._graph_stack.length&&(this._graph_stack.pop().attachCanvas(this),this.setDirty(!0,!0))},p.prototype.setCanvas=function(t){var e=this;if(\"string\"==typeof t&&(t=document.getElementById(t)),null==t)throw\"Error creating LiteGraph canvas: Canvas not found\";if(t!=this.canvas){if(this.canvas=t,t.className+=\" lgraphcanvas\",t.data=this,this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement(\"canvas\"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext)throw\"This browser doesnt support Canvas\";null==(this.ctx=t.getContext(\"2d\"))&&(console.warn(\"This canvas seems to be WebGL, enabling WebGL renderer\"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),t.addEventListener(\"mousedown\",this.processMouseDown.bind(this),!0),t.addEventListener(\"mousemove\",this._mousemove_callback),t.addEventListener(\"contextmenu\",(function(e){return t.focus(),e.preventDefault(),!1})),t.addEventListener(\"mousewheel\",this.processMouseWheel.bind(this),!1),t.addEventListener(\"DOMMouseScroll\",this.processMouseWheel.bind(this),!1),t.addEventListener(\"touchstart\",this.touchHandler.bind(this),!0),t.addEventListener(\"touchmove\",this.touchHandler.bind(this),!0),t.addEventListener(\"touchend\",this.touchHandler.bind(this),!0),t.addEventListener(\"touchcancel\",this.touchHandler.bind(this),!0),t.tabIndex=1e3,t.style.outline=\"none\",t.addEventListener(\"keydown\",(function(t){t.preventDefault(),e.processKeyDown(t)})),t.addEventListener(\"keyup\",(function(t){e.processKeyUp(t)})),t.ondragover=function(){return!1},t.ondragend=function(){return console.log(\"out\"),!1},t.ondrop=function(n){t.focus(),n.preventDefault(),e.adjustMouseEvent(n);var i=[n.canvasX,n.canvasY],s=e.graph.getNodeOnPos(i[0],i[1]);console.log(i);var r=n.dataTransfer.getData(\"text\");if(r){var a=o.createNode(r);return a.pos=i,void e.graph.add(a)}var h=n.dataTransfer.files[0],u=h.name,l=p.getFileExtension(u),d=new FileReader;d.onload=function(t){var n=t.target.result;s&&s.onDropFile&&s.onDropFile(n,u,h,null,gl),e.onDropFile&&(console.log(\"invoke:dropFile\"),e.onDropFile(n,u,h,i)),o.dispatchEvent(\"contentChange\",null,null)},console.log(h);var c=h.type.split(\"/\")[0];return\"text\"==c||\"json\"==l?d.readAsText(h):\"image\"==c?d.readAsDataURL(h):d.readAsArrayBuffer(h),!1}}},p.getFileExtension=function(t){var e=t.indexOf(\"?\");-1!=e&&(t=t.substr(0,e));var n=t.lastIndexOf(\".\");return-1==n?\"\":t.substr(n+1).toLowerCase()},p.prototype.enableWebGL=function(){if(void 0===typeof GL)throw\"litegl.js must be included to use a WebGL canvas\";if(void 0===typeof enableWebGLCanvas)throw\"webglCanvas.js must be included to use this feature\";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl},p.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},p.prototype.getCanvasWindow=function(){var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},p.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}.call(this))},p.prototype.stopRendering=function(){this.is_rendering=!1},p.prototype.processMouseDown=function(t){if(this.graph){this.adjustMouseEvent(t),this.canvas.focus();var e=this.getCanvasWindow();e.document;this.canvas.removeEventListener(\"mousemove\",this._mousemove_callback),e.document.addEventListener(\"mousemove\",this._mousemove_callback,!0),e.document.addEventListener(\"mouseup\",this._mouseup_callback,!0);var n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);n||(n=this.graph.getSubGraphOnPos(t.canvasX,t.canvasY,this.graph._subGraphs));if(1==t.which){if(!t.shiftKey){var i=[];for(var r in this.selected_nodes)this.selected_nodes[r]!=n&&i.push(this.selected_nodes[r]);for(var r in i)this.processNodeDeselected(i[r])}var a=!1;if(n){this.live_mode||n.flags.pinned||(\"subGraph\"!=n.type?(this.bringToFront(n),console.log(\"run bringtofront\")):(this.bringToFrontForSubgraph(n),console.log(\"run bringToFrontForSubgraph\")));var p=!1;if(!this.connecting_node&&!n.flags.collapsed&&!this.live_mode){if(n.outputs){r=0;for(var h=n.outputs.length;r<h;++r){var u=n.outputs[r],l=n.getConnectionPos(!1,r);if(s(t.canvasX,t.canvasY,l[0]-10,l[1]-5,20,10)){this.connecting_node=n,this.connecting_output=u,this.connecting_pos=n.getConnectionPos(!1,r),this.connecting_slot=r,p=!0;break}}}if(n.inputs)for(r=0,h=n.inputs.length;r<h;++r){var d=n.inputs[r];l=n.getConnectionPos(!0,r);s(t.canvasX,t.canvasY,l[0]-10,l[1]-5,20,10)&&d.link&&(n.disconnectInput(r),this.dirty_bgcanvas=!0,p=!0)}null==n.pos&&(n.pos=n.rect.pos,n.size=n.rect.size),!p&&s(t.canvasX,t.canvasY,n.pos[0]+n.size[0]-5,n.pos[1]+n.size[1]-5,5,5)&&(this.resizing_node=n,this.canvas.style.cursor=\"se-resize\",p=!0)}if(n.nodes||p||!s(t.canvasX,t.canvasY,n.pos[0],n.pos[1]-o.NODE_TITLE_HEIGHT,o.NODE_TITLE_HEIGHT,o.NODE_TITLE_HEIGHT)||(n.collapse(),p=!0),!p){var c=!1;o.getTime()-this.last_mouseclick<300&&this.selected_nodes[n.id]&&(n.onDblClick&&n.onDblClick(t),this.processNodeDblClicked(n),c=!0),n.onMouseDown&&n.onMouseDown(t)?c=!0:this.live_mode&&(a=!0,c=!0),c||(this.allow_dragnodes&&(this.node_dragged=n),this.selected_nodes[n.id]||this.processNodeSelected(n,t)),this.dirty_canvas=!0}}else a=!0;a&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==t.which||3==t.which&&this.processContextualMenu(n,t);return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=o.getTime(),this.canvas_mouse=[t.canvasX,t.canvasY],this.graph.change(),(!e.document.activeElement||\"input\"!=e.document.activeElement.nodeName.toLowerCase()&&\"textarea\"!=e.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),!1}},p.prototype.processMouseMove=function(t){if(this.graph){this.adjustMouseEvent(t);var e=[t.localX,t.localY],n=[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]];if(this.last_mouse=e,this.canvas_mouse=[t.canvasX,t.canvasY],this.dragging_canvas)this.offset[0]+=n[0]/this.scale,this.offset[1]+=n[1]/this.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else{this.connecting_node&&(this.dirty_canvas=!0);var i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);for(var r in this.graph._nodes)this.graph._nodes[r].mouseOver&&i!=this.graph._nodes[r]&&(this.graph._nodes[r].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(i){if(i.mouseOver||(i.mouseOver=!0,this.node_over=i,this.dirty_canvas=!0,i.onMouseEnter&&i.onMouseEnter(t)),i.onMouseMove&&i.onMouseMove(t),this.connecting_node){var a=this._highlight_input||[0,0],p=this.isOverNodeInput(i,t.canvasX,t.canvasY,a);if(-1!=p&&i.inputs[p]){i.inputs[p].type;null==this.connecting_node||this.connecting_output.type!=i.inputs[p].type&&!i.compareNodeTypes(this.connecting_node,this.connecting_output,p)||(this._highlight_input=a)}else this._highlight_input=null}s(t.canvasX,t.canvasY,i.pos[0]+i.size[0]-5,i.pos[1]+i.size[1]-5,5,5)?this.canvas.style.cursor=\"se-resize\":this.canvas.style.cursor=null}else this.canvas.style.cursor=null;if(this.node_capturing_input&&this.node_capturing_input!=i&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t),this.node_dragged&&!this.live_mode){for(var r in this.selected_nodes){if((i=this.selected_nodes[r]).pos[0]+=n[0]/this.scale,i.pos[1]+=n[1]/this.scale,null!=i.nodes)for(var h of Object.values(i.nodes))h.pos[0]+=n[0]/this.scale,h.pos[1]+=n[1]/this.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){this.resizing_node.size[0]+=n[0]/this.scale,this.resizing_node.size[1]+=n[1]/this.scale;var u=Math.max(this.resizing_node.inputs?this.resizing_node.inputs.length:0,this.resizing_node.outputs?this.resizing_node.outputs.length:0);this.resizing_node.size[1]<u*o.NODE_SLOT_HEIGHT+4&&(this.resizing_node.size[1]=u*o.NODE_SLOT_HEIGHT+4),this.resizing_node.size[0]<this.resizing_node.title_width&&(this.resizing_node.size[0]=this.resizing_node.title_width),this.canvas.style.cursor=\"se-resize\",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},p.prototype.processMouseUp=function(t){if(this.graph){var e=this.getCanvasWindow().document;if(e.removeEventListener(\"mousemove\",this._mousemove_callback,!0),this.canvas.addEventListener(\"mousemove\",this._mousemove_callback,!0),e.removeEventListener(\"mouseup\",this._mouseup_callback,!0),this.adjustMouseEvent(t),1==t.which)if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var n=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes);if(n)if(\"node\"==this.connecting_output.type)this.connecting_node.connect(this.connecting_slot,n,-1);else{var o=this.isOverNodeInput(n,t.canvasX,t.canvasY);if(-1!=o)this.connecting_node.connect(this.connecting_slot,n,o);else{var i=n.getInputInfo(0);i&&!i.link&&i.type==this.connecting_output.type&&this.connecting_node.connect(this.connecting_slot,n,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.resizing_node=null):this.node_dragged?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.node_dragged=null):(this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t));else(2==t.which||3==t.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},p.prototype.isOverNodeInput=function(t,e,n,o){if(t.inputs)for(var i=0,r=t.inputs.length;i<r;++i){t.inputs[i];var a=t.getConnectionPos(!0,i);if(s(e,n,a[0]-10,a[1]-5,20,10))return o&&(o[0]=a[0],o[1]=a[1]),i}return-1},p.prototype.processKeyDown=function(t){if(this.graph){var e=!1;if(65==t.keyCode&&t.ctrlKey&&(this.selectAllNodes(),e=!0),46!=t.keyCode&&8!=t.keyCode||this.deleteSelectedNodes(),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(t);return this.graph.change(),e?(t.preventDefault(),!1):void 0}},p.prototype.processKeyUp=function(t){if(this.graph){if(this.selected_nodes)for(var e in this.selected_nodes)this.selected_nodes[e].onKeyUp&&this.selected_nodes[e].onKeyUp(t);this.graph.change()}},p.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDelta?t.wheelDelta:-60*t.detail;this.adjustMouseEvent(t);var n=this.scale;return e>0?n*=1.1:e<0&&(n*=1/1.1),this.setZoom(n,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}},p.prototype.onNodeSelected=function(t){},p.prototype.processNodeSelected=function(t,e){o.debug&&console.log(\"node selected:\",t),t.selected=!0,t.onSelected&&t.onSelected(),e&&e.shiftKey||(this.selected_nodes={}),this.selected_nodes[t.id]=t,this.dirty_canvas=!0,this.onNodeSelected&&this.onNodeSelected(t)},p.prototype.processNodeDeselected=function(t){t.selected=!1,t.onDeselected&&t.onDeselected(),delete this.selected_nodes[t.id],this.onNodeDeselected&&this.onNodeDeselected(),this.dirty_canvas=!0},p.prototype.processNodeDblClicked=function(t){this.onShowNodePanel&&this.onShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},p.prototype.selectNode=function(t){this.deselectAllNodes(),t&&(!t.selected&&t.onSelected&&t.onSelected(),t.selected=!0,this.selected_nodes[t.id]=t,this.setDirty(!0))},p.prototype.selectAllNodes=function(){for(var t in this.graph._nodes){var e=this.graph._nodes[t];!e.selected&&e.onSelected&&e.onSelected(),e.selected=!0,this.selected_nodes[this.graph._nodes[t].id]=e}this.setDirty(!0)},p.prototype.deselectAllNodes=function(){for(var t in this.selected_nodes){var e=this.selected_nodes;e.onDeselected&&e.onDeselected(),e.selected=!1}this.selected_nodes={},this.setDirty(!0)},p.prototype.deleteSelectedNodes=function(){for(var t in this.graph.removing=!0,this.selected_nodes){var e=this.selected_nodes[t];console.log(\"delecting node:\",e),\"subGraph\"==e.type?this.graph.removeSubGraph(e):this.graph.remove(e)}this.selected_nodes={},this.setDirty(!0),this.graph.removing=!1,this.graph.updateExecutionOrder()},p.prototype.centerOnNode=function(t){this.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.scale,this.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.scale,this.setDirty(!0,!0)},p.prototype.adjustMouseEvent=function(t){var e=this.canvas.getBoundingClientRect();t.localX=t.pageX-e.left,t.localY=t.pageY-e.top,t.canvasX=t.localX/this.scale-this.offset[0],t.canvasY=t.localY/this.scale-this.offset[1]},p.prototype.setZoom=function(t,e){e||(e=[.5*this.canvas.width,.5*this.canvas.height]);var n=this.convertOffsetToCanvas(e);this.scale=t,this.scale>this.max_zoom?this.scale=this.max_zoom:this.scale<this.min_zoom&&(this.scale=this.min_zoom);var o=this.convertOffsetToCanvas(e),i=[o[0]-n[0],o[1]-n[1]];this.offset[0]+=i[0],this.offset[1]+=i[1],this.dirty_canvas=!0,this.dirty_bgcanvas=!0},p.prototype.convertOffsetToCanvas=function(t){return[t[0]/this.scale-this.offset[0],t[1]/this.scale-this.offset[1]]},p.prototype.convertCanvasToOffset=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},p.prototype.convertEventToCanvas=function(t){var e=this.canvas.getClientRects()[0];return this.convertOffsetToCanvas([t.pageX-e.left,t.pageY-e.top])},p.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},p.prototype.bringToFrontForSubgraph=function(t){for(var e of Object.keys(t.nodes)){var n=this.graph._nodes.indexOf(t.nodes[e]);console.log(n),this.graph._nodes.splice(n,1),this.graph._nodes.push(t.nodes[e])}n=this.graph._subGraphs.indexOf(t),console.log(n),this.graph._subGraphs.splice(n,1),this.graph._subGraphs.push(t)},p.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))},p.prototype.computeVisibleNodes=function(){for(var t,e,n=[],o=this.graph._nodes.length-1;o>=0;--o){var i=this.graph._nodes[o];(!this.live_mode||i.onDrawBackground||i.onDrawForeground)&&(t=this.visible_area,e=i.getBounding(),t[0]>e[2]||t[1]>e[3]||t[2]<e[0]||t[3]<e[1]||n.push(i))}return n},p.prototype.draw=function(t,e){if(0!=this.ctx.canvas.width&&0!=this.ctx.canvas.height){var n=o.getTime();if(this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph){var i=[-this.offset[0],-this.offset[1]],s=[i[0]+this.canvas.width/this.scale,i[1]+this.canvas.height/this.scale];this.visible_area=new Float32Array([i[0],i[1],s[0],s[1]])}(this.dirty_bgcanvas||e)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},p.prototype.drawFrontCanvas=function(){this.ctx||(this.ctx=this.bgcanvas.getContext(\"2d\"));var t=this.ctx;if(t){t.start&&t.start();var e=this.canvas;if(t.restore(),t.setTransform(1,0,0,1,0,0),this.dirty_area&&(t.save(),t.beginPath(),t.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),t.clip()),t.clearRect(0,0,e.width,e.height),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&(t.font=\"10px Arial\",t.fillStyle=\"#888\",this.graph?(t.fillText(\"T: \"+this.graph.globaltime.toFixed(2)+\"s\",5,13),t.fillText(\"I: \"+this.graph.iteration,5,26),t.fillText(\"F: \"+this.frame,5,39),t.fillText(\"FPS:\"+this.fps.toFixed(2),5,52)):t.fillText(\"No graph selected\",5,13)),this.graph){t.save(),t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1]);var n=this.computeVisibleNodes();this.visible_nodes=n;for(var o=n.length-1;o>=0;--o){var i=n[o];t.save(),t.translate(i.pos[0],i.pos[1]),this.drawNode(i,t),1,t.restore()}if(this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var s=\"node\"==this.connecting_output.type?\"#F85\":\"#AFA\";this.renderLink(t,this.connecting_pos,[this.canvas_mouse[0],this.canvas_mouse[1]],s),t.beginPath(),t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),this.connecting_output.round?t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI):t.rect(this.connecting_pos[0],this.connecting_pos[1],12,6),t.fill(),t.fillStyle=\"#ffcc00\",this._highlight_input&&(t.beginPath(),t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill())}t.restore()}this.dirty_area&&t.restore(),t.finish&&t.finish(),this.dirty_canvas=!1}},p.prototype.drawBackCanvas=function(){var t=this.bgcanvas;this.bgctx||(this.bgctx=this.bgcanvas.getContext(\"2d\"));var e=this.bgctx;if(e.start&&e.start(),this.onClearRect&&this.onClearRect(),e.clearRect(0,0,t.width,t.height),e.restore(),e.setTransform(1,0,0,1,0,0),this.graph){if(e.save(),e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1]),this.background_image&&this.scale>.5){if(e.globalAlpha=(1-.5/this.scale)*this.editor_alpha,e.webkitImageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var n=this;this._bg_img.onload=function(){n.draw(!0,!0)}}var o=null;this._bg_img!=this._pattern_img&&this._bg_img.width>0?(o=e.createPattern(this._bg_img,\"repeat\"),this._pattern_img=this._bg_img,this._pattern=o):o=this._pattern,o&&(e.fillStyle=o,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2]-this.visible_area[0],this.visible_area[3]-this.visible_area[1]),e.fillStyle=\"transparent\"),e.globalAlpha=1,e.webkitImageSmoothingEnabled=e.mozImageSmoothingEnabled=e.imageSmoothingEnabled=!0}this.onBackgroundRender&&this.onBackgroundRender(t,e),e.strokeStyle=\"#235\",e.strokeRect(0,0,t.width,t.height),this.render_connections_shadows?(e.shadowColor=\"#000\",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor=\"rgba(0,0,0,0)\";for(var i=0;i<this.graph._subGraphs.length;i++){var s=this.graph._subGraphs[i];this.drawSubGraph(s,e)}this.live_mode||this.drawConnections(e),e.shadowColor=\"rgba(0,0,0,0)\",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},p.prototype.drawSubGraph=function(t,e){var n=o.NODE_TITLE_HEIGHT;t.rect=t.calculateSize();var i=t.rect.size;e.save(),e.fillStyle=\"#555555\",e.beginPath(),e.rect(t.rect.pos[0],t.rect.pos[1],t.rect.size[0],t.rect.size[1]),e.fill(),e.restore(),e.save(),e.translate(t.rect.pos[0],t.rect.pos[1]),e.fillStyle=o.NODE_DEFAULT_COLOR,e.beginPath(),e.rect(0,-n,t.rect.size[0],n),e.fill(),e.fillStyle=o.NODE_DEFAULT_BOXCOLOR,e.beginPath(),e.rect(3,3-n,n-6,n-6),e.fill(),e.font=t.title_text_font,this.scale>.5&&(e.fillStyle=o.NODE_TITLE_COLOR,e.fillText(t.properties.name,16,13-n)),t.selected&&(e.strokeStyle=o.NODE_SELECTED_COLOR,e.strokeRect(-.5,-n-.5,i[0]+2,i[1]+n+2-1)),e.restore()},p.prototype.drawNode=function(t,e){var n=t.color||o.NODE_DEFAULT_COLOR;t.selected&&(n=\"#88F\");var i=t.getTitleWidth()||t.computeTitleWidth(e,this.title_text_font),s=!0;if((t.flags.skip_title_render||t.graph.isLive())&&(s=!1),t.mouseOver&&(s=!0),t.mouseOver&&!0,t.selected||(this.render_shadows?(e.shadowColor=\"rgba(0,0,0,0.5)\",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3):e.shadowColor=\"transparent\"),this.live_mode)t.flags.collapsed||(e.shadowColor=\"transparent\",t.onDrawForeground&&t.onDrawForeground(e));else{var r=this.editor_alpha;e.globalAlpha=r;var a=t.shape||o.NODE_DEFAULT_SHAPE,p=new Float32Array(t.size);t.flags.collapsed&&(p[0]=i,p[1]=0),t.flags.clip_area&&(e.save(),\"box\"==a?(e.beginPath(),e.rect(0,0,p[0],p[1])):\"round\"==a?e.roundRect(0,0,p[0],p[1],10):\"circle\"==a&&(e.beginPath(),e.arc(.5*p[0],.5*p[1],.5*p[0],0,2*Math.PI)),e.clip()),this.drawNodeShape(t,e,p,n,t.bgcolor,!s,t.selected),e.shadowColor=\"transparent\",e.textAlign=\"left\",e.font=this.inner_text_font;var h=this.scale>.6;if(!t.flags.collapsed){if(t.inputs)for(var u=0;u<t.inputs.length;u++){var l=t.inputs[u];if(\"If\"==t.title&&null!=this.connecting_node);if(e.globalAlpha=r,null==this.connecting_node||this.connecting_output.type==t.inputs[u].type&&\"\"!=this.connecting_output.type&&\"\"!=t.inputs[u].type||t.compareNodeTypes(this.connecting_node,this.connecting_output,u)||(e.globalAlpha=.4*r),e.fillStyle=null!=l.link?\"#7F7\":\"#AAA\",(d=t.getConnectionPos(!0,u))[0]-=t.pos[0],d[1]-=t.pos[1],e.beginPath(),e.arc(d[0],d[1],4,0,2*Math.PI),e.fill(),h)(c=null!=l.label?l.label:l.name)&&(e.fillStyle=n,e.fillText(c,d[0]+10,d[1]+5))}if(this.connecting_node&&(e.globalAlpha=.4*r),e.lineWidth=1,e.textAlign=\"right\",e.strokeStyle=\"black\",t.outputs)for(u=0;u<t.outputs.length;u++){var d,c;l=t.outputs[u];if((d=t.getConnectionPos(!1,u))[0]-=t.pos[0],d[1]-=t.pos[1],e.fillStyle=l.links&&l.links.length?\"#7F7\":\"#AAA\",e.beginPath(),e.arc(d[0],d[1],4,0,2*Math.PI),e.fill(),e.stroke(),h)(c=null!=l.label?l.label:l.name)&&(e.fillStyle=n,e.fillText(c,d[0]-10,d[1]+5))}e.textAlign=\"left\",e.globalAlpha=1,t.onDrawForeground&&t.onDrawForeground(e)}t.flags.clip_area&&e.restore(),e.globalAlpha=1}},p.prototype.drawNodeShape=function(t,e,n,i,s,r,a){e.strokeStyle=i||o.NODE_DEFAULT_COLOR,e.fillStyle=s||o.NODE_DEFAULT_BGCOLOR;var p=o.NODE_TITLE_HEIGHT,h=t.shape||o.NODE_DEFAULT_SHAPE;if(\"box\"==h)e.beginPath(),e.rect(0,r?0:-p,n[0]+1,r?n[1]:n[1]+p),e.fill(),e.shadowColor=\"transparent\",a&&(e.strokeStyle=o.NODE_SELECTED_COLOR,e.strokeRect(-.5,r?-.5:-p-.5,n[0]+2,r?n[1]+2:n[1]+p+2-1),e.strokeStyle=i);else if(\"round\"==h){var u=e.roundRect(0,r?0:-p,n[0],r?n[1]:n[1]+p,10);e.fill(),a&&(e.strokeStyle=o.NODE_SELECTED_COLOR,u.stroke(),e.strokeStyle=i)}else\"circle\"==h&&(e.beginPath(),e.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),e.fill());if(e.shadowColor=\"transparent\",t.bgImage&&t.bgImage.width&&e.drawImage(t.bgImage,.5*(n[0]-t.bgImage.width),.5*(n[1]-t.bgImage.height)),t.bgImageUrl&&!t.bgImage&&(t.bgImage=t.loadImage(t.bgImageUrl)),t.onDrawBackground&&t.onDrawBackground(e),!r){e.fillStyle=i||o.NODE_DEFAULT_COLOR;var l=e.globalAlpha;e.globalAlpha=.5*l,\"box\"==h?(e.beginPath(),e.rect(0,-p,n[0]+1,p),e.fill()):\"round\"==h&&(t.flags.collapsed?e.roundRect(0,-p,n[0],p,o.NODE_COLLAPSED_RADIUS,o.NODE_COLLAPSED_RADIUS):e.roundRect(0,-p,n[0],p,10,0),e.fill()),e.fillStyle=t.boxcolor||o.NODE_DEFAULT_BOXCOLOR,e.beginPath(),\"round\"==h?e.arc(.5*p,-.5*p,.5*(p-6),0,2*Math.PI):e.rect(3,3-p,p-6,p-6),e.fill(),e.globalAlpha=l,e.font=this.title_text_font;var d=t.getTitle();d&&this.scale>.5&&(e.fillStyle=o.NODE_TITLE_COLOR,e.fillText(d,16,13-p))}},p.prototype.drawNodeCollapsed=function(t,e,n,i){e.strokeStyle=n||o.NODE_DEFAULT_COLOR,e.fillStyle=i||o.NODE_DEFAULT_BGCOLOR;var s=o.NODE_COLLAPSED_RADIUS,r=t.shape||o.NODE_DEFAULT_SHAPE;\"circle\"==r?(e.beginPath(),e.arc(.5*t.size[0],.5*t.size[1],s,0,2*Math.PI),e.fill(),e.shadowColor=\"rgba(0,0,0,0)\",e.stroke(),e.fillStyle=t.boxcolor||o.NODE_DEFAULT_BOXCOLOR,e.beginPath(),e.arc(.5*t.size[0],.5*t.size[1],.5*s,0,2*Math.PI),e.fill()):\"round\"==r?(e.beginPath(),e.roundRect(.5*t.size[0]-s,.5*t.size[1]-s,2*s,2*s,5),e.fill(),e.shadowColor=\"rgba(0,0,0,0)\",e.stroke(),e.fillStyle=t.boxcolor||o.NODE_DEFAULT_BOXCOLOR,e.beginPath(),e.roundRect(.5*t.size[0]-.5*s,.5*t.size[1]-.5*s,s,s,2),e.fill()):(e.beginPath(),e.rect(0,0,t.size[0],2*s),e.fill(),e.shadowColor=\"rgba(0,0,0,0)\",e.stroke(),e.fillStyle=t.boxcolor||o.NODE_DEFAULT_BOXCOLOR,e.beginPath(),e.rect(.5*s,.5*s,s,s),e.fill())},p.link_colors=[\"#AAC\",\"#ACA\",\"#CAA\"],p.prototype.drawConnections=function(t){t.lineWidth=this.connections_width,t.fillStyle=\"#AAA\",t.strokeStyle=\"#AAA\",t.globalAlpha=this.editor_alpha;for(var e=this.graph._nodes.length-1;e>=0;--e){var n=this.graph._nodes[e];if(n.inputs&&n.inputs.length)for(var o=n.inputs.length-1;o>=0;--o){var i=n.inputs[o];if(i&&null!=i.link){var s=i.link,r=this.graph.links[s];if(r){var a=this.graph.getNodeById(r.origin_id);if(null!=a){var h=r.origin_slot,u=null;u=-1==h?[a.pos[0]+10,a.pos[1]+10]:a.getConnectionPos(!1,h);var l=p.link_type_colors[n.inputs[o].type];null==l&&(l=p.link_colors[n.id%p.link_colors.length]),null!=r.color&&(l=r.color),this.renderLink(t,u,n.getConnectionPos(!0,o),l)}}}}}t.globalAlpha=1},p.prototype.renderLink=function(t,e,n,o){if(!this.highquality_render)return t.beginPath(),t.moveTo(e[0],e[1]),t.lineTo(n[0],n[1]),void t.stroke();var s=i(e,n);if(this.render_connections_border&&this.scale>.6&&(t.lineWidth=this.connections_width+4),t.beginPath(),this.render_curved_connections?(t.moveTo(e[0],e[1]),t.bezierCurveTo(e[0]+.25*s,e[1],n[0]-.25*s,n[1],n[0],n[1])):(t.moveTo(e[0]+10,e[1]),t.lineTo(.5*(e[0]+10+(n[0]-10)),e[1]),t.lineTo(.5*(e[0]+10+(n[0]-10)),n[1]),t.lineTo(n[0]-10,n[1])),this.render_connections_border&&this.scale>.6&&(t.strokeStyle=\"rgba(0,0,0,0.5)\",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=o,t.stroke(),this.render_connection_arrows&&this.scale>.6){var r=this.computeConnectionPoint(e,n,.5),a=this.computeConnectionPoint(e,n,.51),p=0;p=this.render_curved_connections?-Math.atan2(a[0]-r[0],a[1]-r[1]):n[1]>e[1]?0:Math.PI,t.save(),t.translate(r[0],r[1]),t.rotate(p),t.beginPath(),t.moveTo(-5,-5),t.lineTo(0,5),t.lineTo(5,-5),t.fill(),t.restore()}},p.prototype.computeConnectionPoint=function(t,e,n){var o=i(t,e),s=t,r=[t[0]+.25*o,t[1]],a=[e[0]-.25*o,e[1]],p=e,h=(1-n)*(1-n)*(1-n),u=(1-n)*(1-n)*3*n,l=3*(1-n)*(n*n),d=n*n*n;return[h*s[0]+u*r[0]+l*a[0]+d*p[0],h*s[1]+u*r[1]+l*a[1]+d*p[1]]},p.prototype.resize=function(t,e){if(!t&&!e){var n=this.canvas.parentNode;t=n.offsetWidth,e=n.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.ctx&&this.ctx.webgl&&(this.ctx.makeCurrent(),gl.canvas.width=t,gl.canvas.height=e,gl.viewport(0,0,t,e)),this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},p.prototype.switchLiveMode=function(t){if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var e=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var o=setInterval((function(){e.editor_alpha*=n,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,n<1&&e.editor_alpha<.01&&(clearInterval(o),n<1&&(e.live_mode=!0)),n>1&&e.editor_alpha>.99&&(clearInterval(o),e.editor_alpha=1)}),1)},p.prototype.onNodeSelectionChange=function(t){},p.prototype.touchHandler=function(t){var e=t.changedTouches[0],n=\"\";switch(t.type){case\"touchstart\":n=\"mousedown\";break;case\"touchmove\":n=\"mousemove\";break;case\"touchend\":n=\"mouseup\";break;default:return}var o=this.getCanvasWindow(),i=o.document.createEvent(\"MouseEvent\");i.initMouseEvent(n,!0,!0,o,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(i),t.preventDefault()},p.onMenuAddGrp=function(t,e,n,i,s){console.log(\"menu add grp\");var r=o.createSubGraph(i.selected_nodes,i.graph);return r&&(i.graph._subGraphs.push(r),i.graph.setDirtyCanvas(!0,!0)),!1},p.onMenuAdd=function(t,e,n,i,s){var r=i.getCanvasWindow(),a=o.getNodeTypesCategories(),p={};for(var h in a)a[h]&&(p[h]={value:a[h],content:a[h],is_menu:!0});var u=o.createContextualMenu(p,{event:e,callback:function(t,e){var n=t.value,i=o.getNodeTypesInCategory(n),s=[];for(var a in i)s.push({content:i[a].title,value:i[a].type});return o.createContextualMenu(s,{event:e,callback:l,from:u},r),!1},from:n},r);function l(t,e){var n=o.createNode(t.value);n&&(n.pos=i.convertEventToCanvas(s),i.graph.add(n))}return!1},p.onMenuCollapseAll=function(){},p.onMenuNodeEdit=function(){},p.onMenuNodeInputs=function(t,e,n){if(t){var i=t.optional_inputs;if(t.onGetInputs&&(i=t.onGetInputs()),i){var s=[];for(var r in i){var a=i[r],p=a[0];a[2]&&a[2].label&&(p=a[2].label),s.push({content:p,value:a})}o.createContextualMenu(s,{event:e,callback:function(e){if(!t)return;t.addInput(e.value[0],e.value[1],e.value[2])},from:n})}return!1}},p.onMenuNodeOutputs=function(t,e,n){if(t){var i=t.optional_outputs;if(t.onGetOutputs&&(i=t.onGetOutputs()),i){var s=[];for(var r in i)-1==t.findOutputSlot(i[r][0])&&s.push({content:i[r][0],value:i[r]});if(s.length)o.createContextualMenu(s,{event:e,callback:function i(s){if(!t)return;var r=s.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var a=[];for(var p in r)a.push({content:p,value:r[p]});return o.createContextualMenu(a,{event:e,callback:i,from:n}),!1}t.addOutput(s.value[0],s.value[1])},from:n})}return!1}},p.onMenuNodeCollapse=function(t){t.flags.collapsed=!t.flags.collapsed,t.setDirtyCanvas(!0,!0)},p.onMenuNodePin=function(t){t.pin()},p.onMenuNodeColors=function(t,e,n){var i=[];for(var s in p.node_colors){var r=p.node_colors[s],a={value:s,content:\"<span style='display: block; color:\"+r.color+\"; background-color:\"+r.bgcolor+\"'>\"+s+\"</span>\"};i.push(a)}return o.createContextualMenu(i,{event:e,callback:function(e){if(!t)return;var n=p.node_colors[e.value];n&&(t.color=n.color,t.bgcolor=n.bgcolor,t.setDirtyCanvas(!0))},from:n}),!1},p.onMenuNodeShapes=function(t,e){return o.createContextualMenu([\"box\",\"round\"],{event:e,callback:function(e){if(!t)return;t.shape=e,t.setDirtyCanvas(!0)}}),!1},p.onMenuNodeRemove=function(t){0!=t.removable&&(\"subGraph\"==t.type?t.graph.removeSubGraph(t):t.graph.remove(t),t.graph.sendActionToCanvas(\"setDirty\",[!0,!0]))},p.onMenuSubgraphPrefab=function(t){o.registerNodeType(\"subGraph/\"+t.title,h),vik.lo},p.onMenuNodeClone=function(t,e,n,o){var i=[],s={};for(var r in o.selected_nodes){if(0!=(p=o.selected_nodes[r]).clonable){var a=p.clone();if(!a)return;a.pos=[p.pos[0]+15,p.pos[1]+15],i.push(a),p.graph.add(a),s[p.id]=a.id,p.setDirtyCanvas(!0,!0)}}for(var r in i){var p=i[r];for(var h in p.inputs){var u=p.inputs[h].link,l=t.graph.links[u];if(l){var d=s[l.origin_id],c=t.graph.getNodeById(d);c?l.origin_id=c.id:c=t.graph.getNodeById(l.origin_id),c.outputs[l.origin_slot].links.push(l.id),l.target_id=p.id}}}},p.node_colors={red:{color:\"#FAA\",bgcolor:\"#A44\"},green:{color:\"#AFA\",bgcolor:\"#4A4\"},blue:{color:\"#AAF\",bgcolor:\"#44A\"},white:{color:\"#FFF\",bgcolor:\"#AAA\"}},p.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=Object.keys(this.selected_nodes).length>1?[{content:\"Add Node\",is_menu:!0,callback:p.onMenuAdd},{content:\"Add Node Group\",callback:p.onMenuAddGrp,nodeList:this.selected_nodes}]:[{content:\"Add Node\",is_menu:!0,callback:p.onMenuAdd}],this._graph_stack&&this._graph_stack.length>0&&(t=[{content:\"Close subgraph\",callback:this.closeSubgraph.bind(this)},null].concat(t))),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this);e&&(e.push(null),t=e.concat(t))}return t},p.prototype.getNodeMenuOptions=function(t){var e=null;if(e=t.getMenuOptions?t.getMenuOptions(this):[{content:\"Inputs\",is_menu:!0,disabled:!0,callback:p.onMenuNodeInputs},{content:\"Outputs\",is_menu:!0,disabled:!0,callback:p.onMenuNodeOutputs},null,{content:\"Collapse\",callback:p.onMenuNodeCollapse},{content:\"Pin\",callback:p.onMenuNodePin},{content:\"Colors\",is_menu:!0,callback:p.onMenuNodeColors},{content:\"Shapes\",is_menu:!0,callback:p.onMenuNodeShapes},null],t.getExtraMenuOptions){var n=t.getExtraMenuOptions(this);n&&(n.push(null),e=n.concat(e))}if(console.log(t),\"subGraph\"==t.type&&e.push({content:\"subgraph prefab\",callback:p.onMenuSubgraphPrefab}),!1!==t.clonable&&e.push({content:\"Clone\",callback:p.onMenuNodeClone}),!1!==t.removable&&e.push(null,{content:\"Remove\",callback:p.onMenuNodeRemove}),t.onGetInputs){var o=t.onGetInputs();o&&o.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var i=t.onGetOutputs();i&&i.length&&(e[1].disabled=!1)}return e},p.prototype.processContextualMenu=function(t,e){var n=this,i=this.getCanvasWindow(),s=o.createContextualMenu(t?this.getNodeMenuOptions(t):this.getCanvasMenuOptions(),{event:e,callback:function(o,i){if(!o)return;if(o.callback)return o.callback(t,i,s,n,e)}},i)},u.VERTEX=1,u.FRAGMENT=2,u.BOTH=3,u.ORDER_MODIFIER=0,u.prototype.getBody=function(){return this.body_hash},u.prototype.setPartialBody=function(t,e,n){if(\"\"!=(t=t||\"\")){n=n||t.hashCode();var o=void 0!==e?e:this.order;if(void 0===this.body_hash[n])return[t,e];if(this.body_hash[n].order>o)return[t,e]}return null},u.prototype.setBody=function(t,e,n){var o;\"\"!==(t=t||\"\")&&(n=n||t.hashCode(),o=this.body_hash[n],e=void 0!==e?e:this.order,void 0!==o?o.order>e&&(o.order=e):this.body_hash[n]={str:t,order:e})},u.prototype.getHeader=function(){return this.header},u.prototype.setHeaderFromHashMap=function(t){for(var e,n=Object.keys(t),o=0,i=n.length;o<i;o++)e=n[o],this.header[e]=t[e]},u.prototype.setHeaderFromMap=function(t){for(var e,n=Object.keys(t),o=0,i=n.length;o<i;o++)e=n[o],this.header[e.hashCode()]=e},u.prototype.addHeaderLine=function(t){var e=t.hashCode();this.header[e]=t},u.prototype.setIncludesFromHashMap=function(t){for(var e,n=Object.keys(t),o=0,i=n.length;o<i;o++)e=n[o],this.includes[e]=t[e]},u.prototype.setIncludesFromMap=function(t){for(var e,n=Object.keys(t),o=0,i=n.length;o<i;o++)e=n[o],this.includes[e.hashCode()]=e},u.prototype.isLineIncluded=function(t){var e=\"\"+t.hashCode();return this.includes.hasOwnProperty(e)},u.prototype.setScope=function(t){this.scope=t},u.prototype.merge=function(t){for(var e,n,o=t.getBody(),i=Object.keys(o),s=0,r=i.length;s<r;s++)n=void 0!==(n=o[e=i[s]].order)?n:t.order,this.setBody(o[e].str,n,e);this.setHeaderFromHashMap(t.getHeader()),this.setIncludesFromHashMap(t.includes)},u.prototype.partialMerge=function(t){for(var e,n,o=t.getBody(),i={},s=Object.keys(o),r=0,a=s.length;r<a;r++){n=void 0!==(n=o[e=s[r]].order)?n:t.order;var p=this.setPartialBody(o[e].str,n,e);null!==p&&(i[p[0]]=p[1])}return this.setHeaderFromHashMap(t.getHeader()),this.setIncludesFromHashMap(t.includes),i},u.prototype.clone=function(){return this},u.prototype.isCodeUsed=function(){return Object.keys(this.getBody()).length>0||Object.keys(this.getHeader()).length>0},o.CodeLib={},l.prototype.getOutputVar=function(){return this.output_var},l.prototype.setOrder=function(t){this.order=t,this.vertex.order=this.order,this.fragment.order=this.order},l.prototype.merge=function(t){t!==o.EMPTY_CODE&&this!==o.EMPTY_CODE&&(this.vertex.merge(t.vertex),this.fragment.merge(t.fragment))},l.prototype.partialMerge=function(t){if(t===o.EMPTY_CODE||this===o.EMPTY_CODE)return[\"\",\"\"];var e=this.vertex.partialMerge(t.vertex),n=this.fragment.partialMerge(t.fragment);return[this.getCodeStringFromMap(e),this.getCodeStringFromMap(n)]},l.prototype.clone=function(){var t=new l(this.vertex.clone(),this.fragment.clone(),this.output_var);return t.order=this.order,t},l.prototype.sortMapByValue=function(t){var e=[];for(var n in t)e.push([n,t[n]]);return e.sort((function(t,e){return t[1]-e[1]})),e},l.prototype.getCodeStringFromMap=function(t){var e=\"\",n=this.sortMapByValue(t);for(var o in n)e+=\"         \"+n[o][0];return e},o.EMPTY_CODE=new l;var d={};function c(t){var e=[];for(var n in t)e.push([n,t[n]]);return e.sort((function(t,e){return t[1].order-e[1].order})),e}d.createShader=function(t,e,n,o,i,s,r,a,p,h,u,l){var d=this.createVertexCode(t,e,n,o,i,s,r,a,p,h),c=this.createFragmentCode(t,e,n,o,i,s,r,a,p,h,u,l),g={};return g.vertex_code=d,g.fragment_code=c,g},d.createVertexCode=function(t,e,n,o,i,s,r,a,p,h){var u=\"precision mediump float;\\nattribute vec3 a_vertex;\\nattribute vec3 a_normal;\\nattribute vec2 a_coord;\\n\";e.vertex.isLineIncluded(\"v_coord\")&&(u+=\"varying vec2 v_coord;\\n\"),u+=\"varying vec3 v_normal;\\n\",u+=\"varying vec3 v_pos;\\n\",u+=\"uniform float u_time;\\n\",e.vertex.isLineIncluded(\"u_frame_time\")&&(u+=\"uniform float u_frame_time;\\n\"),u+=\"uniform vec3 u_eye;\\n\",u+=\"uniform mat4 u_mvp;\\nuniform mat4 u_model;\\nuniform mat4 u_viewprojection;\\n\",u+=\"uniform vec3 u_light_dir;\\n\",u+=\"uniform vec4 u_light_color;\\n\",u+=\"uniform float u_alpha_threshold;\\n\";var l=e.vertex.getHeader();for(var d in l)u+=l[d];u+=\"void main() {\\n\",e.vertex.isLineIncluded(\"v_coord\")&&(u+=\"      v_coord = a_coord;\\n\"),u+=\"      v_normal = (u_model * vec4(a_normal, 0.0)).xyz;\\n\",u+=\"      vec3 pos = a_vertex;\\n\",e.vertex.isLineIncluded(\"depth\")&&(u+=\"      vec4 pos4 = (u_model * vec4(pos,1.0));\\n\",u+=\"      float depth = pos4.z / pos4.w;\\n\"),e.vertex.isLineIncluded(\"view_dir\")&&(u+=\"      vec3 view_dir = normalize(v_pos - u_eye);\\n      vec3 light_dir = normalize(u_light_dir);\\n      vec3 half_dir = normalize(view_dir + light_dir);\\n\");var g=c(e.vertex.getBody());for(var f in g)u+=\"      \"+g[f][1].str;return h.getOutputVar()&&(u+=\"      pos += a_normal * \"+h.getOutputVar()+\";\\n\"),u+=\"      v_pos = (u_model * vec4(pos,1.0)).xyz;\\n\",u+=\"      gl_Position = u_mvp * vec4(pos,1.0);\\n}\\n\"},d.createFragmentCode=function(t,e,n,i,s,r,a,p,h,u,l,d){r.fragment.isCodeUsed(),e.fragment.isCodeUsed(),n.fragment.isCodeUsed(),s.fragment.isCodeUsed(),i.fragment.isCodeUsed(),a.fragment.isCodeUsed(),p.fragment.isCodeUsed(),h.fragment.isCodeUsed(),l.fragment.isCodeUsed();e.fragment!==o.EMPTY_CODE.fragment&&e.fragment.addHeaderLine(\"uniform samplerCube u_cube_default_texture;\\n\");var g=\"#extension GL_OES_standard_derivatives : enable\\nprecision mediump float;\\n\";e.fragment.isLineIncluded(\"v_coord\")&&(g+=\"varying vec2 v_coord;\\n\"),g+=\"varying vec3 v_normal;\\n\",g+=\"varying vec3 v_pos;\\n\",g+=\"uniform float u_time;\\n\",e.fragment.isLineIncluded(\"u_frame_time\")&&(g+=\"uniform float u_frame_time;\\n\"),g+=\"uniform vec3 u_eye;\\n\",g+=\"uniform vec4 u_color;\\n\",g+=\"uniform vec3 u_light_dir;\\n\",g+=\"uniform vec4 u_light_color;\\n\",g+=\"uniform float u_alpha_threshold;\\n\",g+=\"uniform vec3 u_camera_target;\\n\",g+=\"uniform vec3 u_camera_pos;\\n\",g+=\"uniform vec2 iResolution;\\n\";var f=e.fragment.getHeader();for(var _ in f)g+=f[_];e.fragment.isLineIncluded(\"TBN\")&&(g+=\"\\nmat3 computeTBN(){\\n      vec3 dp1 = dFdx( v_pos );\\n      vec3 dp2 = dFdy( v_pos );\\n      vec2 duv1 = dFdx( v_coord );\\n      vec2 duv2 = dFdy( v_coord );\\n      vec3 dp2perp = cross( dp2, v_normal );\\n      vec3 dp1perp = cross( v_normal, dp1 );\\n      vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\\n      vec3 binormal = dp2perp * duv1.y + dp1perp * duv2.y;\\n      float invmax = inversesqrt( max( dot(tangent,tangent), dot(binormal,binormal) ) );\\n      return mat3( tangent * invmax, binormal * invmax, v_normal );\\n}\\n\\n\"),g+=\"\\n#define AA 1\\nmat3 setCamera( in vec3 ro, in vec3 ta, float cr )\\n{     \\n    \\n//vec3 cw = normalize(ta-ro);\\n//vec3 cp = vec3(sin(cr), cos(cr),0.0);\\n//vec3 cu = normalize( cross(cw,cp) );\\n//vec3 cv =          ( cross(cu,cw) );\\n//return mat3( cu, cv, cw );\\nfloat fl = 2.45;\\nvec3 w = normalize(ta-ro);\\nfloat k = inversesqrt(1.0-w.y*w.y);\\nreturn  mat3( vec3(-w.z,0.0,w.x)*k, \\n                vec3(-w.x*w.y,1.0-w.y*w.y,-w.y*w.z)*k,\\n                -w);\\n\\n}\\nvec4 opU(vec4 d1,vec4 d2){return (d1.x < d2.x)?d1:d2;}\\n \\nfloat smin( float a, float b, float k )\\n{\\n    float h = max(k-abs(a-b),0.0);\\n    return min(a, b) - h*h*0.25/k;\\n}\\n\\n// http://iquilezles.org/www/articles/smin/smin.htm\\nvec2 smin2( vec2 a, vec2 b, float k )\\n{\\n    float h = clamp( 0.5+0.5*(b.x-a.x)/k, 0.0, 1.0 );\\n    return mix( b, a, h ) - k*h*(1.0-h);\\n}\\n\\n// http://iquilezles.org/www/articles/smin/smin.htm\\nfloat smax( float a, float b, float k )\\n{\\n    float h = max(k-abs(a-b),0.0);\\n    return max(a, b) + h*h*0.25/k;\\n}\\n\\n// http://www.iquilezles.org/www/articles/distfunctions/distfunctions.htm\\nfloat sdSphere( vec3 p, float s )\\n{\\n    return length(p)-s;\\n}\\n// http://www.iquilezles.org/www/articles/distfunctions/distfunctions.htm\\nfloat sdEllipsoid( in vec3 p, in vec3 r ) // approximated\\n{\\n    float k0 = length(p/r);\\n    float k1 = length(p/(r*r));\\n    return k0*(k0-1.0)/k1;\\n}\\nvec2 sdStick(vec3 p, vec3 a, vec3 b, float r1, float r2) // approximated\\n{\\n    vec3 pa = p-a, ba = b-a;\\n\\tfloat h = clamp( dot(pa,ba)/dot(ba,ba), 0.0, 1.0 );\\n\\treturn vec2( length( pa - ba*h ) - mix(r1,r2,h*h*(3.0-2.0*h)), h );\\n}\\n\\n\\n\\nfloat href;\\nfloat hsha;\\nvec4 map( in vec3 pos, float atime )\\n{\\n \\n    hsha = 1.0;\\n    float t1 = fract(atime);\\n    float t4 = abs(fract(atime*0.5)-0.5)/0.5;\\n\\n    float p = 4.0*t1*(1.0-t1);\\n    float pp = 4.0*(1.0-2.0*t1); // derivative of p\\n\\n    vec3 cen = vec3( 0.0,\\n                     //0.5*(-1.0 + 2.0*t4),\\n                     //pow(p,2.0-p) + 0.1,\\n                     0.3,\\n                     0);\\n                     //floor(atime) + pow(t1,0.7) -1.0 );\\n\\n    // body\\n    vec2 uu = normalize(vec2( 1.0, -pp ));\\n    vec2 vv = vec2(-uu.y, uu.x);\\n    \\n    float sy = 0.5 + 0.5*p;\\n    float compress = 1.0-smoothstep(0.0,0.4,p);\\n    sy = sy*(1.0-compress) + compress;\\n    float sz = 1.0/sy;\\n    \\n    //弹球\\n    vec3 q = pos - cen;\\n    float rot = -0.25*(-1.0 + 2.0*t4);\\n    float rc = cos(rot);\\n    float rs = sin(rot);\\n    //q.xy =mat2(rc,rs,-rs,rc)*q.xy;\\n    vec3 r = q;\\n    href = q.y;\\n    //q.yz = vec2( dot(uu,q.yz), dot(vv,q.yz) );\\n    \";var v=\"\";varsdfbodyhash=l.fragment.getBody();var y=c(varsdfbodyhash);for(var m in y)v+=\"      \"+y[m][1].str;g+=v,g+=\"vec4 res =\"+l.getOutputVar()+\";\\n\",g+=\"\\n    /*\\n    vec4 res = vec4( sdEllipsoid( q, vec3(0.25, \\n        0.25,\\n        //0.25*sy,\\n        0.25 \\n        //0.25*sz\\n        ) ), 2.0, 0.0, 1.0 );\\n        */\\n    // head\\n    vec3 h = r;\\n    float hr = sin(0.791*atime);\\n    hr = 0.7*sign(hr)*smoothstep(0.5,0.7,abs(hr));\\n    h.xz = mat2(cos(hr),sin(hr),-sin(hr),cos(hr))*h.xz;\\n    vec3 hq = vec3( abs(h.x), h.yz );\\n    float d  = sdEllipsoid( h-vec3(0.0,0.20,0.02), vec3(0.08,0.2,0.15) );\\n    float d2 = sdEllipsoid( h-vec3(0.0,0.21,-0.1), vec3(0.20,0.2,0.20) );\\n    d = smin( d, d2, 0.1 );\\n    //res.x = smin( res.x, d, 0.1 );\\n    /*\\n    // ears\\n    {\\n    float t3 = fract(atime+0.9);\\n    float p3 = 4.0*t3*(1.0-t3);\\n    vec2 ear = sdStick( hq, vec3(0.15,0.32,-0.05), vec3(0.2+0.05*p3,0.2+0.2*p3,-0.07), 0.01, 0.04 );\\n    res.xz = smin2( res.xz, ear, 0.01 );\\n    }\\n    \\n    // mouth\\n    {\\n    d = sdEllipsoid( h-vec3(0.0,0.15+4.0*hq.x*hq.x,0.15), vec3(0.1,0.04,0.2) );\\n    res.w = 0.3+0.7*clamp( d*150.0,0.0,1.0);\\n    res.x = smax( res.x, -d, 0.03 );\\n    }\\n    \\n    // eye\\n    {\\n    float blink = pow(0.5+0.5*sin(2.1*atime),20.0);\\n    float eyeball = sdSphere(hq-vec3(0.08,0.27,0.06),0.065+0.02*blink);\\n    res.x = smin( res.x, eyeball, 0.03 );\\n    \\n    vec3 cq = hq-vec3(0.1,0.34,0.08);\\n    cq.xy = mat2(0.8,0.6,-0.6,0.8)*cq.xy;\\n    d = sdEllipsoid( cq, vec3(0.06,0.03,0.03) );\\n    res.x = smin( res.x, d, 0.03 );\\n\\n    float eo = 1.0-0.5*smoothstep(0.01,0.04,length((hq.xy-vec2(0.095,0.285))*vec2(1.0,1.1)));\\n    res = opU( res, vec4(sdSphere(hq-vec3(0.08,0.28,0.08),0.060),3.0,0.0,eo));\\n    res = opU( res, vec4(sdSphere(hq-vec3(0.075,0.28,0.102),0.0395),4.0,0.0,1.0));\\n    }\\n    */\\n    // ground\\n    float fh = -0.1 - 0.05*(sin(pos.x*2.0)+sin(pos.z*2.0));\\n    float t5f = fract(atime+0.05);\\n    float t5i = floor(atime+0.05); \\n    float bt4 = abs(fract(t5i*0.5)-0.5)/0.5;\\n    //wave center\\n    vec2  bcen = vec2(0.5*(-1.0+2.0*bt4),0);//vec2( 0.5*(-1.0+2.0*bt4),t5i+pow(t5f,0.7)-1.0 );\\n    \\n    float k = length(pos.xz-bcen);\\n    float tt = t5f*15.0-6.2831 - k*3.0;\\n    //wave \\n    fh -= 0.1*exp(-k*k)*sin(tt)*exp(-max(tt,0.0)/2.0)*smoothstep(0.0,0.01,t5f);\\n    d = pos.y;// - fh;\\n\\n    //x as depth\\n     \\n    // bubbles\\n    {\\n    vec3 vp = vec3( mod(abs(pos.x),3.0)-1.5,pos.y,mod(pos.z+1.5,3.0)-1.5);\\n    vec2 id = vec2( floor(pos.x/3.0), floor((pos.z+1.5)/3.0) );\\n    float fid = id.x*11.1 + id.y*31.7;\\n    //bubbly height\\n    float fy = fract(fid*1.312+atime*0.1);\\n    float y = -1.0+4.0*fy;\\n    vec3  rad = vec3(0.7,1.0+0.5*sin(fid),0.7);\\n    rad -= 0.1*(sin(pos.x*3.0)+sin(pos.y*4.0)+sin(pos.z*5.0));    \\n    float siz = 4.0*fy*(1.0-fy);\\n    float d2 = sdEllipsoid( vp-vec3(0.5,y,0.0), siz*rad );\\n    \\n    d2 -= 0.03*smoothstep(-1.0,1.0,sin(18.0*pos.x)+sin(18.0*pos.y)+sin(18.0*pos.z));\\n    d2 *= 0.6;\\n    d2 = min(d2,2.0);\\n    d = smin( d, d2, 0.32 );\\n    if( d<res.x ) { res = vec4(d,1.0,0.0,1.0); hsha=sqrt(siz); }\\n    }\\n    \\n    return res;\\n}\\n\\n\\nvec4 castRay( in vec3 ro, in vec3 rd, float time )\\n{\\n    vec4 res = vec4(-1.0,-1.0,0.0,1.0);\\n\\n    float tmin = 0.5;\\n    float tmax = 20.0;\\n    \\n\\t#if 1\\n    // raytrace bounding plane\\n    float tp = (3.5-ro.y)/rd.y;\\n    if( tp>0.0 ) tmax = min( tmax, tp );\\n\\t#endif    \\n    \\n    float t = tmin;\\n    for( int i=0; i<256; i++ )\\n    {\\n        vec4 h = map( ro+rd*t, time );\\n        if( abs(h.x)<(0.0005*t) )\\n        { \\n            res = vec4(t,h.yzw); \\n            break;\\n        }\\n        t += h.x;\\n    }\\n    \\n    return res;\\n}\\n\\nfloat calcSoftshadow( in vec3 ro, in vec3 rd, float time )\\n{\\n    float res = 1.0;\\n\\n    float tmax = 12.0;\\n    #if 1\\n    float tp = (3.5-ro.y)/rd.y; // raytrace bounding plane\\n    if( tp>0.0 ) tmax = min( tmax, tp );\\n\\t#endif    \\n    \\n    float t = 0.02;\\n    for( int i=0; i<50; i++ )\\n    {\\n\\t\\tfloat h = map( ro + rd*t, time ).x;\\n        res = min( res, mix(1.0,16.0*h/t, hsha) );\\n        t += clamp( h, 0.05, 0.40 );\\n        if( res<0.005 || t>tmax ) break;\\n    }\\n    return clamp( res, 0.0, 1.0 );\\n}\\n \\n\\n// http://iquilezles.org/www/articles/normalsSDF/normalsSDF.htm\\nvec3 calcNormal( in vec3 pos, float time )\\n{\\n    \\n#if 1\\n    vec2 e = vec2(1.0,-1.0)*0.5773*0.001;\\n    return normalize( e.xyy*map( pos + e.xyy, time ).x + \\n\\t\\t\\t\\t\\t  e.yyx*map( pos + e.yyx, time ).x + \\n\\t\\t\\t\\t\\t  e.yxy*map( pos + e.yxy, time ).x + \\n\\t\\t\\t\\t\\t  e.xxx*map( pos + e.xxx, time ).x );\\n#else\\n    // inspired by tdhooper and klems - a way to prevent the compiler from inlining map() 4 times\\n    vec3 n = vec3(0.0);\\n    for( int i=0; i<4; i++ )\\n    {\\n        vec3 e = 0.5773*(2.0*vec3((((i+3)>>1)&1),((i>>1)&1),(i&1))-1.0);\\n        n += e*map(pos+0.001*e,time).x;\\n    }\\n    return normalize(n);\\n#endif    \\n}\\n\\nfloat calcOcclusion( in vec3 pos, in vec3 nor, float time )\\n{\\n\\tfloat occ = 0.0;\\n    float sca = 1.0;\\n    for( int i=0; i<5; i++ )\\n    {\\n        float h = 0.01 + 0.11*float(i)/4.0;\\n        vec3 opos = pos + h*nor;\\n        float d = map( opos, time ).x;\\n        occ += (h-d)*sca;\\n        sca *= 0.95;\\n    }\\n    return clamp( 1.0 - 2.0*occ, 0.0, 1.0 );\\n}\\n\\nvec3 render( in vec3 ro, in vec3 rd, float time )\\n{ \\n    // sky dome\\n    vec3 col = vec3(0.5, 0.8, 0.9) - max(rd.y,0.0)*0.5;\\n    // sky clouds\\n    vec2 uv = 1.5*rd.xz/rd.y;\\n    float cl  = 1.0*(sin(uv.x)+sin(uv.y)); uv *= mat2(0.8,0.6,-0.6,0.8)*2.1;\\n    cl += 0.5*(sin(uv.x)+sin(uv.y));\\n    col += 0.1*(-1.0+2.0*smoothstep(-0.1,0.1,cl-0.4));\\n    // sky horizon\\n    col = mix( col, vec3(0.5, 0.7, .9), exp(-10.0*max(rd.y,0.0)) );    \\n    // scene geometry\\n    vec4 res = castRay(ro,rd, time);\\n    \\n    if( res.y>-0.5)\\n    {\\n        float t = res.x;\\n        vec3 pos = ro + t*rd;\\n        vec3 nor = calcNormal( pos, time );\\n        vec3 ref = reflect( rd, nor );\\n        float focc = res.w;\\n        \\n        // material        \\n\\t\\tcol = vec3(0.2);\\n        float ks = 1.0;\\n\\n        if( res.y>3.5 ) // eyeball\\n        { \\n            col = vec3(0.0);\\n        } \\n        else if( res.y>2.5 ) // iris\\n        { \\n            col = vec3(0.4);\\n        } \\n        else if( res.y>1.5 ) // body\\n        { \\n            col = mix(vec3(0.144,0.09,0.0036),vec3(0.36,0.1,0.04),res.z*res.z);\\n            col = mix(col,vec3(0.14,0.09,0.06)*2.0, (1.0-res.z)*smoothstep(-0.15, 0.15, -href));\\n        }\\n\\n        \\n        else{\\n        // terrain\\n        \\n        // base green            \\n        \\n        col = vec3(0.05,0.09,0.02);\\n        float f = 0.2*(-1.0+2.0*smoothstep(-0.2,0.2,sin(18.0*pos.x)+sin(18.0*pos.y)+sin(18.0*pos.z)));\\n        col += f*vec3(0.06,0.06,0.02);\\n        ks = 0.5 + pos.y*0.15;\\n        \\n        }\\n    // lighting (sun, sky, bounce, back, sss)\\n    float occ = calcOcclusion( pos, nor, time )*focc;\\n    float fre = clamp(1.0+dot(nor,rd),0.0,1.0);\\n    \\n    vec3  sun_lig = normalize( vec3(0.6, 0.35, 0.5) );\\n    float sun_dif = clamp(dot( nor, sun_lig ), 0.0, 1.0 );\\n    vec3  sun_hal = normalize( sun_lig-rd );\\n    float sun_sha = calcSoftshadow( pos, sun_lig, time );\\n    float sun_spe = ks*pow(clamp(dot(nor,sun_hal),0.0,1.0),8.0)*sun_dif*(0.04+0.96*pow(clamp(1.0+dot(sun_hal,rd),0.0,1.0),5.0));\\n    float sky_dif = sqrt(clamp( 0.5+0.5*nor.y, 0.0, 1.0 ));\\n    float sky_spe = ks*smoothstep( 0.0, 0.5, ref.y )*(0.04+0.96*pow(fre,4.0));\\n    float bou_dif = sqrt(clamp( 0.1-0.9*nor.y, 0.0, 1.0 ))*clamp(1.0-0.1*pos.y,0.0,1.0);\\n    float bac_dif = clamp(0.1+0.9*dot( nor, normalize(vec3(-sun_lig.x,0.0,-sun_lig.z))), 0.0, 1.0 );\\n    float sss_dif = fre*sky_dif*(0.25+0.75*sun_dif*sun_sha);\\n\\n    vec3 lin = vec3(0.0);\\n    lin += sun_dif*vec3(8.10,6.00,4.20)*vec3(sun_sha,sun_sha*sun_sha*0.5+0.5*sun_sha,sun_sha*sun_sha);\\n    lin += sky_dif*vec3(0.50,0.70,1.00)*occ;\\n    lin += bou_dif*vec3(0.20,0.70,0.10)*occ;\\n    lin += bac_dif*vec3(0.45,0.35,0.25)*occ;\\n    lin += sss_dif*vec3(3.25,2.75,2.50)*occ;\\n    col = col*lin;\\n    col += sun_spe*vec3(9.90,8.10,6.30)*sun_sha;\\n    col += sky_spe*vec3(0.20,0.30,0.65)*occ*occ;\\n    \\n    col = pow(col,vec3(0.8,0.9,1.0) );\\n    \\n    // fog\\n    col = mix( col, vec3(0.5,0.7,0.9), 1.0-exp( -0.0001*t*t*t ) );\\n        \\n        \\n    }\\n    \\n    return col;\\n\\n    \\n\\n}\\n \\n    \",g+=\"void main() {\\n\";v=\"albedo:\\n\";var b=c(e.fragment.getBody());for(var m in b)v+=\"      \"+b[m][1].str;return g+=\"\\n    \\n    vec3 tot = vec3(0.0);\\n     \\n    vec2 p = (-iResolution.xy + 2.0*(gl_FragCoord.xy-0.5))/iResolution.y;\\n    float time = u_time;\\n    \\n    time += -2.6;\\n    time *= 0.9;\\n    \\n    // camera\\t\\n    /*\\n    float cl = sin(0.5*time);\\n    float an = 1.57 + 0.7*sin(0.15*time);\\n    vec3  ta = vec3( 0.0, 0.65, -0.6+time*1.0 - 0.4*cl);\\n    vec3  ro = ta + vec3( 1.3*cos(an), -0.250, 1.3*sin(an) );\\n    float ti = fract(time-0.15);\\n    ti = 4.0*ti*(1.0-ti);        \\n    ta.y += 0.15*ti*ti*(3.0-2.0*ti)*smoothstep(0.4,0.9,cl);\\n    \\n    // camera bounce\\n    \\n    float t4 = abs(fract(time*0.5)-0.5)/0.5;\\n    float bou = -1.0 + 2.0*t4;\\n    ro += 0.06*sin(time*12.0+vec3(0.0,2.0,4.0))*smoothstep( 0.85, 1.0, abs(bou) );\\n    */\\n    // camera-to-world rotation\\n    //vec3 ro = vec3(-0.045+0.05,-0.04,1.3);\\n    //vec3 ta = vec3(-0.19,-0.08,0.0);\\n    \",g+=\"\\n    vec3 ro = u_camera_pos;\\n    vec3 ta = u_camera_target;\\n    mat3 ca = setCamera( ta,ro, 0.0 );\\n\\n    // ray direction\\n    //5是fov 2020.5.3\\n    vec3 rd = ca * normalize( vec3(p,2.2) );\\n    \\n    // render\\t\\n    vec3 col = render( ro, rd, time );\\n        \\n    // color grading\\n    col = col*vec3(1.11,0.89,0.79);\\n\\n    // compress        \\n    col = 1.35*col/(1.0+col);\\n    \\n    // gamma\\n    col = pow( col, vec3(0.4545));\\n\\n    tot += col;\\n\\n\\n    // s-surve    \\n    tot = clamp(tot,0.0,1.0);\\n    tot = tot*tot*(3.0-2.0*tot);\\n\\n    // vignetting        \\n    //vec2 q = fragCoord/iResolution.xy;\\n    //tot *= 0.5 + 0.5*pow(16.0*q.x*q.y*(1.0-q.x)*(1.0-q.y),0.25);\\n\\n    // output    \\n \\n    gl_FragColor = vec4( tot, 1.0 );\\n    \\n    \",g+=\"}\"};var g={};function f(t,e){this.type=t,this.name=e,this.id=\"1paramfunc\",this.includes={}}function _(t,e){this.type=t,this.name=e,this.id=\"2paramfunc\",this.includes={}}function v(t,e){this.type=t,this.name=e,this.id=\"3paramfunc\",this.includes={}}function y(t,e){this.type=t,this.name=e,this.id=\"constant\",this.includes={u_model:1,a_normal:1,v_normal:1}}g.id=\"frame_time\",g.includes={u_frame_time:1},g.getVertexCode=function(){return\"\"},g.getFragmentCode=function(){return\"\"},g.getCode=function(t){t.scope;var e=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,n=new u(e);n.setIncludesFromMap(g.includes);var o=new u(e);return o.setBody(this.getVertexCode()),o.setIncludesFromMap(g.includes),new l(o,n,\"u_frame_time\")},f.prototype.getVertexCode=function(t,e,n,o){return n==u.VERTEX||n==u.BOTH?(o||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\");\\n\":\"\"},f.prototype.getFragmentCode=function(t,e,n,o){return n==u.FRAGMENT||n==u.BOTH?(o||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\");\\n\":\"\"},f.prototype.getCode=function(t){var e=t.out_var,n=t.a,o=t.scope,i=t.out_type,s=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,r=new u(s);r.setBody(this.getVertexCode(e,n,o,i)),r.setIncludesFromMap(this.includes);var a=new u(s);return a.setBody(this.getFragmentCode(e,n,o,i)),a.setIncludesFromMap(this.includes),new l(r,a,e)},o.CodeLib.length=new f(\"float\",\"length\"),o.CodeLib.exp2=new f(void 0,\"exp2\"),o.CodeLib.sin=new f(void 0,\"sin\"),o.CodeLib.normalize=new f(void 0,\"normalize\"),o.CodeLib.cos=new f(void 0,\"cos\"),o.CodeLib.tan=new f(void 0,\"tan\"),o.CodeLib.asin=new f(void 0,\"asin\"),o.CodeLib.acos=new f(void 0,\"acos\"),o.CodeLib.atan=new f(void 0,\"atan\"),o.CodeLib.abs=new f(void 0,\"abs\"),o.CodeLib.sign=new f(void 0,\"sign\"),o.CodeLib.floor=new f(void 0,\"floor\"),o.CodeLib.ceil=new f(void 0,\"ceil\"),o.CodeLib.fract=new f(void 0,\"fract\"),_.prototype.getVertexCode=function(t,e,n,o,i){return o==u.VERTEX||o==u.BOTH?(i||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\",\"+n+\");\\n\":\"\"},_.prototype.getFragmentCode=function(t,e,n,o,i){return o==u.FRAGMENT||o==u.BOTH?(i||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\",\"+n+\");\\n\":\"\"},_.prototype.getCode=function(t){var e=t.out_var,n=t.a,o=t.b,i=t.scope,s=t.out_type,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new u(r);a.setBody(this.getVertexCode(e,n,o,i,s)),a.setIncludesFromMap(this.includes);var p=new u(r);return p.setBody(this.getFragmentCode(e,n,o,i,s)),p.setIncludesFromMap(this.includes),new l(a,p,e)},o.CodeLib.distance=new _(\"float\",\"distance\"),o.CodeLib.dot=new _(\"float\",\"dot\"),o.CodeLib.cross=new _(\"vec3\",\"cross\"),o.CodeLib.reflect=new _(void 0,\"reflect\"),o.CodeLib.mod=new _(void 0,\"mod\"),o.CodeLib.min=new _(void 0,\"min\"),o.CodeLib.max=new _(void 0,\"max\"),o.CodeLib.step=new _(void 0,\"step\"),o.CodeLib.pow=new _(void 0,\"pow\"),v.prototype.getVertexCode=function(t,e,n,o,i,s){return i==u.VERTEX||i==u.BOTH?(s||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\",\"+n+\",\"+o+\");\\n\":\"\"},v.prototype.getFragmentCode=function(t,e,n,o,i,s){return i==u.FRAGMENT||i==u.BOTH?(s||this.type)+\" \"+t+\" = \"+this.name+\"(\"+e+\",\"+n+\",\"+o+\");\\n\":\"\"},v.prototype.getCode=function(t){var e=t.out_var,n=t.a,o=t.b,i=t.c,s=t.scope,r=t.out_type,a=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,p=new u(a);p.setBody(this.getVertexCode(e,n,o,i,s,r)),p.setIncludesFromMap(this.includes);var h=new u(a);return h.setBody(this.getFragmentCode(e,n,o,i,s,r)),h.setIncludesFromMap(this.includes),new l(p,h,e)},o.CodeLib.distance=new v(\"float\",\"distance\"),o.CodeLib.refract=new v(void 0,\"refract\"),o.CodeLib.mix=new v(void 0,\"mix\"),o.CodeLib.smoothstep=new v(void 0,\"smoothstep\"),o.CodeLib.clamp=new v(void 0,\"clamp\"),y.prototype.getVertexCode=function(t,e,n){return n==u.VERTEX||n==u.BOTH?this.type+\" \"+t+\" = \"+e+\";\\n\":\"\"},y.prototype.getFragmentCode=function(t,e,n){return n==u.FRAGMENT||n==u.BOTH?this.type+\" \"+t+\" = \"+e+\";\\n\":\"\"},y.prototype.getCode=function(t){var e=t.out_var,n=t.a,o=!!t.hasOwnProperty(\"is_global\")&&t.is_global,i=t.scope,s=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,r=new u(s),a=new u(s);if(o){var p={};p[\"uniform \"+this.type+\" \"+e+\";\\n\"]=1,r.setHeaderFromMap(p),a.setHeaderFromMap(p)}else r.setBody(this.getVertexCode(e,n,i)),a.setBody(this.getFragmentCode(e,n,i));return a.setIncludesFromMap(this.includes),r.setIncludesFromMap(this.includes),new l(r,a,e)},y.prototype.setType=function(t){this.type=t};var b={};function C(){this.id=\"reflected_vector\",this.includes={v_pos:1,v_normal:1,u_eye:1,v_coord:1,camera_to_pixel_ws:1}}b.id=\"pixel_normal_ws\",b.includes={u_model:1,a_normal:1,v_normal:1},b.getVertexCode=function(){return\"\"},b.getFragmentCode=function(){return\"vec3 pixel_normal_ws = normal;\\n\"},b.getCode=function(t){var e=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,n=new u(e);n.setBody(this.getVertexCode()),n.setIncludesFromMap(b.includes);var o=new u(e);return o.setBody(this.getFragmentCode()),o.setIncludesFromMap(b.includes),new l(n,o,\"pixel_normal_ws\")},C.prototype.getVertexCode=function(){return\"\"},C.prototype.getFragmentCode=function(){return\"vec3 pixel_normal_ws = normal;\\n      vec3 reflected_vector = reflect(view_dir,pixel_normal_ws);\\n\"},C.prototype.getCode=function(t){var e=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,n=new u(e);n.setBody(this.getVertexCode()),n.setIncludesFromMap(this.includes);var o=new u(e);return o.setBody(this.getFragmentCode()),o.setIncludesFromMap(this.includes),new l(n,o,\"reflected_vector\")};var O={};function T(){this.id=\"vec_to_vec\",this.includes={}}O.id=\"uvs\",O.includes={v_coord:1},O.already_included=!1,O.getVertexCode=function(t,e,n,o){return o==u.VERTEX||o==u.BOTH?\"vec2 \"+t+\" = v_coord * vec2(\"+e+\",\"+n+\");\\n\":\"\"},O.getFragmentCode=function(t,e,n,o){return o==u.FRAGMENT||o==u.BOTH?\"vec2 \"+t+\" = v_coord * vec2(\"+e+\",\"+n+\");\\n\":\"\"},O.getCode=function(t){var e=t.out_var,n=t.utiling||\"1.000\",o=t.vtiling||\"1.000\",i=t.scope,s=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,r=\"1.000\"!==n||\"1.000\"!==o,a=new u(s);r&&a.setBody(this.getFragmentCode(e,n,o,i)),a.setIncludesFromMap(O.includes);var p=new u(s);return r&&p.setBody(this.getVertexCode(e,n,o,i)),p.setIncludesFromMap(O.includes),new l(p,a,r?e:\"v_coord\")},T.prototype.getCastedVar=function(t,e,n,o){var i=parseInt(e.slice(-1)),s=parseInt(n.slice(-1));if(isNaN(i)&&(i=1),isNaN(s)&&(s=1),!(s>i)){for(var r=e+\"(\"+o,a=0;a<i-s;++a)r+=\", 0.0\";return r+=\");\\n\"}return\"float\"==e?o+\".x;\\n\":\"vec2\"==e?o+\".xy;\\n\":\"vec3\"==e?o+\".xyz;\\n\":\"vec4\"==e?o+\".xyzw;\\n\":void 0},T.prototype.getVertexCode=function(t,e,n,o,i){return i==u.VERTEX||i==u.BOTH?e+\" \"+t+\" = \"+this.getCastedVar(t,e,n,o):\"\"},T.prototype.getFragmentCode=function(t,e,n,o,i){return i==u.FRAGMENT||i==u.BOTH?e+\" \"+t+\" = \"+this.getCastedVar(t,e,n,o):\"\"},T.prototype.getCode=function(t){var e=t.out_var,n=t.in_type,o=t.out_type,i=t.a,s=t.scope,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new u(r);a.setBody(this.getVertexCode(e,o,n,i,s)),a.setIncludesFromMap(this.includes);var p=new u(r);return p.setBody(this.getFragmentCode(e,o,n,i,s)),p.setIncludesFromMap(this.includes),new l(a,p,e)};var E={};function w(){this.id=\"if\",this.includes={}}function x(t,e){this.type=t,this.op=e,this.id=\"operation\",this.includes={}}function k(){this.id=\"fresnel\",this.includes={u_model:1,a_normal:1,v_normal:1,view_dir:1}}function I(){this.id=\"panner\",this.includes={u_time:1}}E.id=\"cameratopixelws\",E.includes={v_pos:1,u_eye:1},E.already_included=!1,E.getVertexCode=function(t){var e=new u(t);return e.setIncludesFromMap(E.includes),e},E.getFragmentCode=function(t){var e=new u(t);return e.setIncludesFromMap(E.includes),e},E.getCode=function(t){var e=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,n=this.getFragmentCode(e);return new l(this.getVertexCode(e),n,\"v_pos\")},w.prototype.getVertexCode=function(t,e,n,o,i,s,r,a,p,h,l){return l==u.VERTEX||l==u.BOTH?t+\" \"+e+\";\\n      if(\"+n+\" > \"+o+\")\\n      {\\n\"+(i=i?i+\"\":\"\")+(a=a?\"         \"+e+\" = \"+a+\";\\n\":\"\")+\"      } else if (\"+n+\" < \"+o+\"){\\n\"+(s=s?s+\"\":\"\")+(p=p?\"         \"+e+\" = \"+p+\";\\n\":\"\")+\"      } else {\\n\"+(r=r?r+\"\":\"\")+(h=h?\"         \"+e+\" = \"+h+\";\\n\":\"\")+\"      }\\n\":\"\"},w.prototype.getFragmentCode=function(t,e,n,o,i,s,r,a,p,h,l){return l==u.FRAGMENT||l==u.BOTH?t+\" \"+e+\";\\n      if(\"+n+\" > \"+o+\")\\n      {\\n\"+(i=i?i+\"\":\"\")+(a=a?\"         \"+e+\" = \"+a+\";\\n\":\"\")+\"      } else if (\"+n+\" < \"+o+\"){\\n\"+(s=s?s+\"\":\"\")+(p=p?\"         \"+e+\" = \"+p+\";\\n\":\"\")+\"      } else {\\n\"+(r=r?r+\"\":\"\")+(h=h?\"         \"+e+\" = \"+h+\";\\n\":\"\")+\"      }\\n\":\"\"},w.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.a,i=t.b,s=t.gt,r=t.lt,a=t.eq,p=t.gt_out,h=t.lt_out,d=t.eq_out,c=t.scope,g=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,f=new u(g);f.setBody(this.getVertexCode(n,e,o,i,s,r,a,p,h,d,c)),f.setIncludesFromMap(this.includes);var _=new u(g);return _.setBody(this.getFragmentCode(n,e,o,i,s,r,a,p,h,d,c)),_.setIncludesFromMap(this.includes),new l(f,_,e)},x.prototype.getVertexCode=function(t,e,n,o,i){return o==u.VERTEX||o==u.BOTH?(i||this.type)+\" \"+t+\" = \"+e+\" \"+this.op+\" \"+n+\";\\n\":\"\"},x.prototype.getFragmentCode=function(t,e,n,o,i){return o==u.FRAGMENT||o==u.BOTH?(i||this.type)+\" \"+t+\" = \"+e+\" \"+this.op+\" \"+n+\";\\n\":\"\"},x.prototype.getCode=function(t){var e=t.out_var,n=t.a,o=t.b,i=t.scope,s=t.out_type,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new u(r);a.setBody(this.getVertexCode(e,n,o,i,s)),a.setIncludesFromMap(this.includes);var p=new u(r);return p.setBody(this.getFragmentCode(e,n,o,i,s)),p.setIncludesFromMap(this.includes),new l(a,p,e)},o.CodeLib.add=new x(void 0,\"+\"),o.CodeLib.sub=new x(void 0,\"-\"),o.CodeLib.mul=new x(void 0,\"*\"),o.CodeLib.div=new x(void 0,\"/\"),k.prototype.getVertexCode=function(t,e,n,o){return o==u.VERTEX||o==u.BOTH?\"float fresnel_\"+t+\" = dot(\"+(e=e||\"v_normal\")+\", -view_dir);\\n      float \"+t+\" = pow( 1.0 - clamp(fresnel_\"+t+\",0.0,1.0), \"+n+\");\\n\":\"\"},k.prototype.getFragmentCode=function(t,e,n,o){return o==u.FRAGMENT||o==u.BOTH?\"float fresnel_\"+t+\" = dot(\"+(e=e||\"normal\")+\", -view_dir);\\n      float \"+t+\" = pow( 1.0 - clamp(fresnel_\"+t+\",0.0,1.0), \"+n+\");\\n\":\"\"},k.prototype.getCode=function(t){var e=t.out_var,n=t.exp||\"1.0\",o=t.scope,i=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,s=t.normal,r=new u(i);r.setBody(this.getVertexCode(e,s,n,o)),o!=u.VERTEX&&o!=u.BOTH||r.setIncludesFromMap(this.includes);var a=new u(i);return a.setBody(this.getFragmentCode(e,s,n,o)),o!=u.FRAGMENT&&o!=u.BOTH||a.setIncludesFromMap(this.includes),new l(r,a,e)},I.prototype.getVertexCode=function(t,e,n,o,i,s,r){n=\"\"==n?\"u_time\":n;return s==u.VERTEX||s==u.BOTH?r+\" \"+t+\" = \"+e+\";\\n      \"+t+\".x += \"+o+\" * \"+n+\";\\n      \"+t+\".y += \"+i+\" * \"+n+\";\\n\":\"\"},I.prototype.getFragmentCode=function(t,e,n,o,i,s,r){n=\"\"==n?\"u_time\":n;return s==u.FRAGMENT||s==u.BOTH?r+\" \"+t+\" = \"+e+\";\\n      \"+t+\".x += \"+o+\" * \"+n+\";\\n      \"+t+\".y += \"+i+\" * \"+n+\";\\n\":\"\"},I.prototype.getCode=function(t){var e=t.out_var,n=t.input,o=t.time,i=t.dx,s=t.dy,r=t.scope,a=t.out_type,p=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,h=new u(p);h.setBody(this.getVertexCode(e,n,o,i,s,r,a)),h.setIncludesFromMap(this.includes);var d=new u(p);return d.setBody(this.getFragmentCode(e,n,o,i,s,r,a)),d.setIncludesFromMap(this.includes),new l(h,d,e)}},function(t,e){window.nodeSubGraph=function(t,e){this._ctor(t,e)},nodeSubGraph.prototype._ctor=function(t,e){this.nodes=jQuery.extend(!0,{},t),this.boundary=20,this.properties={name:\"unnamed\"},this.title_width=LiteGraph.NODE_MIN_WIDTH,this.rect=this.calculateSize(),this.graph=e,this.id=-1,this.type=\"subGraph\",this.links=[],this.flags={};var n=Object.values(this.nodes).map(t=>t.title),o=Object.values(this.nodes).map(t=>t.id),i=Object.values(this.nodes).map(t=>t.inputs);for(var s in this.properties.hash=\"\",i){var r=i[s];if(r){var a=r.map(t=>t.link);for(var p of a)if(p){var h=e.links[p].origin_id,u=e.links[p].origin_slot,l=e.links[p].target_id,d=e.links[p].target_slot;if(-1!=o.indexOf(h)){this.links.push(e.links[p]);var c=\"|\"+n[o.indexOf(h)];c+=\"_\"+u+\":\",c+=n[o.indexOf(l)],c+=\"_\"+d,n[o.indexOf(l)]+=c}}}}for(var g of(n.sort(),n))this.properties.hash+=g+\";\"},nodeSubGraph.prototype.calculateSize=function(){var t=[],e=[],n=[],o=[];for(var i of Object.values(this.nodes))t.push(i.pos[0]),n.push(i.pos[1]),e.push(i.pos[0]+i.size[0]),o.push(i.pos[1]+i.size[1]);t.sort((function(t,e){return t-e})),n.sort((function(t,e){return t-e})),e.sort((function(t,e){return e-t})),o.sort((function(t,e){return e-t}));var s={pos:[t[0]-this.boundary,n[0]-this.boundary],size:[e[0]-t[0]+2*this.boundary,o[0]-n[0]+2*this.boundary]};return s.center=[s.pos[0]+s.size[0]/2,s.pos[1]+s.size[1]/2],s},nodeSubGraph.prototype.serialize=function(){var t=[];for(var e in this.nodes){var n=this.nodes[e].serialize();t.push(n),n.pos=this.nodes[e].pos,console.log(n.inputs)}return console.log(\"nodes saved:\",t),{type:\"subGraph\",title:this.title,nodes:t,name:this.properties.name}}},function(t,e){function n(){this._ctor(n.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"a\",\"\",{float:1}),this.addInput(\"b\",\"\",{float:1}),this.addInput(\"k\",\"\",{float:1}),this.properties.name=\"\",this.options=this.options||{},this.properties.optType=\"min\",this.options.optType={multichoice:[\"min\",\"max\"],reloadonchange:1},this.shader_piece=new c}function o(){this._ctor(o.title),this.addOutput(\"result\",\"\",{vec2:1}),this.addInput(\"a\",\"\",{vec2:1}),this.addInput(\"b\",\"\",{vec2:1}),this.addInput(\"k\",\"\",{float:1}),this.properties={name:\"\"},this.options=this.options||{},this.shader_piece=new g}function i(){this._ctor(i.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"p\",\"\",{vec3:1}),this.addInput(\"s\",\"\",{float:1}),this.properties={name:\"\"},this.options=this.options||{},this.shader_piece=new f}function s(){this._ctor(s.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"p\",\"\",{vec3:1}),this.addInput(\"r\",\"\",{vec3:1}),this.properties={name:\"\"},this.options=this.options||{},this.shader_piece=new _}function r(){this._ctor(r.title),this.addOutput(\"result\",\"\",{vec4:1}),this.addInput(\"d1\",\"\",{vec4:1}),this.addInput(\"d2\",\"\",{vec4:1}),this.properties={name:\"\"},this.options=this.options||{},this.shader_piece=new v}function a(){this._ctor(a.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"p\",\"\",{vec3:1}),this.addInput(\"a\",\"\",{vec3:1}),this.addInput(\"b\",\"\",{vec3:1}),this.addInput(\"r1\",\"\",{float:1}),this.addInput(\"r2\",\"\",{float:1}),this.options=this.options||{},this.shader_piece=new y,this.properties={name:\"\"}}function h(){this._ctor(h.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"p\",\"\",{float:1}),this.options=this.options||{},this.properties={name:\"\"},this.shader_piece=new f}function u(){this._ctor(u.title),this.addOutput(\"result\",\"\",{float:1}),this.addInput(\"r1\",\"\",{float:1}),this.addInput(\"r2\",\"\",{float:1}),this.addInput(\"r3\",\"\",{float:1}),this.addInput(\"r4\",\"\",{float:1}),this.options=this.options||{},this.properties={name:\"\"},this.shader_piece=new f}function l(){this._ctor(l.title),this.addOutput(\"result\",\"\",{vec3:1}),this.output_types={vec3:1},this.options=this.options||{},this.properties={name:\"\"},this.shader_piece=new C}function d(){this._ctor(d.title),this.addOutput(\"result\",\"\",{float:1}),this.output_types={float:1},this.options=this.options||{},this.shader_piece=new O}function c(){this.id=\"smooth\",this.includes={}}function g(){this.id=\"smooth2d\",this.includes={}}function f(){this.id=\"sdSphere\",this.includes={}}function _(){this.id=\"sdEllipsoid\",this.includes={}}function v(){this.id=\"opU\",this.includes={}}function y(){this.id=\"sdStick\",this.includes={}}function m(){this.id=\"sign\",this.includes={}}function b(){this.id=\"mat2\",this.includes={}}function C(){this.id=\"pos\",this.includes={}}function O(){this.id=\"atime\",this.includes={}}n.title=\"smooth\",n.desc=\"smooth\",n.prototype.onExecute=function(){},n.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE,o=this.getInputCode(2)||LiteGraph.EMPTY_CODE;if(e&&n&&o){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var i=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"smooth_\"+this.id:this.properties.name,out_type:this.getOutputType(),a:e.getOutputVar(),b:n.getOutputVar(),k:o.getOutputVar(),optType:this.properties.optType,scope:t,order:this.order});i.merge(e),i.merge(n),i.merge(o)}else this.codes[0]=LiteGraph.EMPTY_CODE},n.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+n.title,n),o.title=\"smooth2d\",o.desc=\"smooth2d\",o.prototype.onExecute=function(){},o.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE,o=this.getInputCode(2)||LiteGraph.EMPTY_CODE;if(e&&n&&o){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var i=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"smooth2d_\"+this.id:this.properties.name,out_type:this.getOutputType(),a:e.getOutputVar(),b:n.getOutputVar(),k:o.getOutputVar(),scope:t,order:this.order});i.merge(e),i.merge(n),i.merge(o)}else this.codes[0]=LiteGraph.EMPTY_CODE},o.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+o.title,o),i.title=\"sdSphere\",i.desc=\"sdSphere\",i.prototype.onExecute=function(){},i.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE;if(e&&n){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var o=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"sdSphere_\"+this.id:this.properties.name,out_type:this.getOutputType(),p:e.getOutputVar(),s:n.getOutputVar(),scope:t,order:this.order});o.merge(e),o.merge(n)}else this.codes[0]=LiteGraph.EMPTY_CODE},i.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+i.title,i),s.title=\"sdEllipsoid\",s.desc=\"sdEllipsoid\",s.prototype.onExecute=function(){},s.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE;if(e&&n){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var o=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"sdEllipsoid_\"+this.id:this.properties.name,out_type:this.getOutputType(),p:e.getOutputVar(),r:n.getOutputVar(),scope:t,order:this.order});o.merge(e),o.merge(n)}else this.codes[0]=LiteGraph.EMPTY_CODE},s.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+s.title,s),r.title=\"popU\",r.desc=\"popU\",r.prototype.onExecute=function(){},r.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE;if(e&&n){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var o=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"popU_\"+this.id:this.properties.name,out_type:this.getOutputType(),d1:e.getOutputVar(),d2:n.getOutputVar(),scope:t,order:this.order});o.merge(e),o.merge(n)}else this.codes[0]=LiteGraph.EMPTY_CODE},r.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+r.title,r),a.title=\"sdStick\",a.desc=\"sdStick\",a.prototype.onExecute=function(){},a.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE,o=this.getInputCode(2)||LiteGraph.EMPTY_CODE,i=this.getInputCode(3)||LiteGraph.EMPTY_CODE,s=this.getInputCode(4)||LiteGraph.EMPTY_CODE;if(e&&n&&o&&i&&s){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var r=this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"sdStick_\"+this.id:this.properties.name,out_type:this.getOutputType(),p:e.getOutputVar(),a:n.getOutputVar(),b:o.getOutputVar(),r1:i.getOutputVar(),r2:s.getOutputVar(),scope:t,order:this.order});r.merge(e),r.merge(n),r.merge(o),r.merge(i),r.merge(s)}else this.codes[0]=LiteGraph.EMPTY_CODE},a.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+a.title,a),h.title=\"sign\",h.desc=\"sign\",h.prototype.onExecute=function(){},h.prototype.processInputCode=function(t){var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE;e?(this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name,(this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"sign_\"+this.id:this.properties.name,out_type:this.getOutputType(),p:e.getOutputVar(),scope:t,order:this.order})).merge(e)):this.codes[0]=LiteGraph.EMPTY_CODE},h.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+h.title,h),u.title=\"mat2\",u.desc=\"mat2\",u.prototype.onExecute=function(){},u.prototype.processInputCode=function(t){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name;var e=this.getInputCode(0)||LiteGraph.EMPTY_CODE,n=this.getInputCode(1)||LiteGraph.EMPTY_CODE,o=this.getInputCode(2)||LiteGraph.EMPTY_CODE,i=this.getInputCode(3)||LiteGraph.EMPTY_CODE;e&&n&&o&&i?(this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name,(this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"mat2_\"+this.id:this.properties.name,out_type:this.getOutputType(),r1:e.getOutputVar(),r2:n.getOutputVar(),r3:o.getOutputVar(),r4:i.getOutputVar(),is_global:!0,scope:t,order:this.order})).merge(p)):this.codes[0]=LiteGraph.EMPTY_CODE},u.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"math/\"+u.title,u),l.title=\"pos\",l.desc=\"pos\",l.prototype.onExecute=function(){},l.prototype.processInputCode=function(t){this.outputs[0].name=\"\"==this.properties.name?\"result\":this.properties.name,this.codes[0]=this.shader_piece.getCode({out_var:\"\"==this.properties.name?\"pos_\"+this.id:this.properties.name,out_type:this.getOutputType(),scope:t,order:this.order})},l.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"constants/\"+l.title,l),d.title=\"atime\",d.desc=\"atime\",d.prototype.onExecute=function(){},d.prototype.processInputCode=function(t){this.codes[0]=this.shader_piece.getCode({out_var:\"atime_\"+this.id,out_type:this.getOutputType(),scope:t,order:this.order})},d.prototype.getOutputType=function(){var t=this.output_types?this.output_types:this.T_out_types;return LiteGraph.getOtputTypeFromMap(t)},LiteGraph.registerNodeType(\"constants/\"+d.title,d),c.prototype.getVertexCode=function(t,e,n,o,i,s,r){if(r==CodePiece.VERTEX||r==CodePiece.BOTH)return\"float h =max(\"+i+\"-abs(\"+n+\"-\"+o+\"),0.0);\\n\"+t+\" \"+e+\"=\"+s+\"(\"+n+\",\"+o+\") -h*h*0.25/\"+i+\";\\n\"},c.prototype.getFragmentCode=function(t,e,n,o,i,s,r){if(r==CodePiece.FRAGMENT||r==CodePiece.BOTH)return t+\" \"+e+\"=smin(\"+n+\",\"+o+\",\"+i+\");\\n\"},c.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.a,i=t.b,s=t.k,r=t.optType,a=t.scope,p=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,h=new CodePiece(p);h.setBody(this.getVertexCode(n,e,o,i,s,r,a)),h.setIncludesFromMap(this.includes);var u=new CodePiece(p);return u.setBody(this.getFragmentCode(n,e,o,i,s,r,a)),u.setIncludesFromMap(this.includes),new ShaderCode(h,u,e)},g.prototype.getVertexCode=function(t,e,n,o,i,s){if(s==CodePiece.VERTEX||s==CodePiece.BOTH)return\"float h =clamp(0.5+0.5*(\"+o+\".x-\"+n+\".x)/\"+i+\",0.0,1.0);\\n\"+t+\" \"+e+\"=mix(\"+o+\",\"+n+\",h) -\"+i+\"*h*(1.0-h);\\n\"},g.prototype.getFragmentCode=function(t,e,n,o,i,s){if(s==CodePiece.FRAGMENT||s==CodePiece.BOTH)return t+\" \"+e+\"=smin2(\"+n+\",\"+o+\",\"+i+\");\\n\"},g.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.a,i=t.b,s=t.k,r=t.scope,a=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,p=new CodePiece(a);p.setBody(this.getVertexCode(n,e,o,i,s,r)),p.setIncludesFromMap(this.includes);var h=new CodePiece(a);return h.setBody(this.getFragmentCode(n,e,o,i,s,r)),h.setIncludesFromMap(this.includes),new ShaderCode(p,h,e)},f.prototype.getVertexCode=function(t,e,n,o,i){if(i==CodePiece.VERTEX||i==CodePiece.BOTH)return t+\" \"+e+\"=length(\"+n+\")-\"+o+\";\\n\"},f.prototype.getFragmentCode=function(t,e,n,o,i){if(i==CodePiece.FRAGMENT||i==CodePiece.BOTH)return t+\" \"+e+\"=sdSphere(\"+n+\",\"+o+\");\\n\"},f.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.p,i=t.s,s=t.scope,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new CodePiece(r);a.setBody(this.getVertexCode(n,e,o,i,s)),a.setIncludesFromMap(this.includes);var p=new CodePiece(r);return p.setBody(this.getFragmentCode(n,e,o,i,s)),p.setIncludesFromMap(this.includes),new ShaderCode(a,p,e)},_.prototype.getVertexCode=function(t,e,n,o,i){if(i==CodePiece.VERTEX||i==CodePiece.BOTH)return t+\" \"+e+\"= sdEllipsoid(\"+n+\",\"+o+\");\\n\"},_.prototype.getFragmentCode=function(t,e,n,o,i){if(i==CodePiece.FRAGMENT||i==CodePiece.BOTH)return t+\" \"+e+\"= sdEllipsoid(\"+n+\",\"+o+\");\\n\"},_.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.p,i=t.r,s=t.scope,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new CodePiece(r);a.setBody(this.getVertexCode(n,e,o,i,s)),a.setIncludesFromMap(this.includes);var p=new CodePiece(r);return p.setBody(this.getFragmentCode(n,e,o,i,s)),p.setIncludesFromMap(this.includes),new ShaderCode(a,p,e)},v.prototype.getVertexCode=function(t,e,n,o,i){if(i==CodePiece.VERTEX||i==CodePiece.BOTH)return t+\" \"+e+\"=(\"+n.x+\"<\"+o.x+\")?\"+n+\":\"+o+\" ;\\n\"},v.prototype.getFragmentCode=function(t,e,n,o,i){if(i==CodePiece.FRAGMENT||i==CodePiece.BOTH)return t+\" \"+e+\"= opU(\"+n+\",\"+o+\");\\n\"},v.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.d1,i=t.d2,s=t.scope,r=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,a=new CodePiece(r);a.setBody(this.getVertexCode(n,e,o,i,s)),a.setIncludesFromMap(this.includes);var p=new CodePiece(r);return p.setBody(this.getFragmentCode(n,e,o,i,s)),p.setIncludesFromMap(this.includes),new ShaderCode(a,p,e)},y.prototype.getVertexCode=function(t,e,n,o,i,s,r,a){if(a==CodePiece.VERTEX||a==CodePiece.BOTH)return\"vec3 pa =\"+n+\"-\"+o+\",ba=\"+i+\"-\"+o+\";\\nfloat h = clamp(dot(pa,ba)/dot(ba,ba),0,0,1,0);\"+t+\" \"+e+\"=vec2(length(pa-ba*h)-mix(\"+s+\",\"+r+\",h*h*(3.0-2.0*h)),h);\\n\"},y.prototype.getFragmentCode=function(t,e,n,o,i,s,r,a){if(a==CodePiece.FRAGMENT||a==CodePiece.BOTH)return t+\" \"+e+\"=sdStick(\"+n+\",\"+o+\",\"+i+\",\"+s+\",\"+r+\");\\n\"},y.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.p,i=t.a,s=t.b,r=t.r1,a=t.r2,p=t.scope,h=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,u=new CodePiece(h);u.setBody(this.getVertexCode(n,e,o,i,s,r,a,p)),u.setIncludesFromMap(this.includes);var l=new CodePiece(h);return l.setBody(this.getFragmentCode(n,e,o,i,s,r,a,p)),l.setIncludesFromMap(this.includes),new ShaderCode(u,l,e)},m.prototype.getVertexCode=function(t,e,n,o){if(o==CodePiece.VERTEX||o==CodePiece.BOTH)return t+\" \"+e+\"=sign(\"+n+\");\\n\"},m.prototype.getFragmentCode=function(t,e,n,o){if(o==CodePiece.FRAGMENT||o==CodePiece.BOTH)return t+\" \"+e+\"=sign(\"+n+\");\\n\"},m.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.p,i=t.scope,s=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,r=new CodePiece(s);r.setBody(this.getVertexCode(n,e,o,i)),r.setIncludesFromMap(this.includes);var a=new CodePiece(s);return a.setBody(this.getFragmentCode(n,e,o,i)),a.setIncludesFromMap(this.includes),new ShaderCode(r,a,e)},b.prototype.getVertexCode=function(t,e,n,o,i,s,r){if(r==CodePiece.VERTEX||r==CodePiece.BOTH)return t+\" \"+e+\"=mat2(\"+n+\",\"+o+\",\"+i+\",\"+s+\");\\n\"},b.prototype.getFragmentCode=function(t,e,n,o,i,s,r){if(r==CodePiece.FRAGMENT||r==CodePiece.BOTH)return t+\" \"+e+\"=mat2(\"+n+\",\"+o+\",\"+i+\",\"+s+\");\\n\"},b.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.r1,i=t.r2,s=t.r3,r=t.r4,a=t.scope,p=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,h=new CodePiece(p);h.setBody(this.getVertexCode(n,e,o,i,s,r,a)),h.setIncludesFromMap(this.includes);var u=new CodePiece(p);return u.setBody(this.getFragmentCode(n,e,o,i,s,r,a)),u.setIncludesFromMap(this.includes),new ShaderCode(h,u,e)},C.prototype.getVertexCode=function(t,e,n){if(n==CodePiece.VERTEX||n==CodePiece.BOTH)return t+\" \"+e+\"=pos;\\n\"},C.prototype.getFragmentCode=function(t,e,n){if(n==CodePiece.FRAGMENT||n==CodePiece.BOTH)return t+\" \"+e+\"=pos;\\n\"},C.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.scope,i=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,s=new CodePiece(i);s.setBody(this.getVertexCode(n,e,o)),s.setIncludesFromMap(this.includes);var r=new CodePiece(i);return r.setBody(this.getFragmentCode(n,e,o)),r.setIncludesFromMap(this.includes),new ShaderCode(s,r,e)},O.prototype.getVertexCode=function(t,e,n){if(n==CodePiece.VERTEX||n==CodePiece.BOTH)return t+\" \"+e+\"=aTime;\\n\"},O.prototype.getFragmentCode=function(t,e,n){if(n==CodePiece.FRAGMENT||n==CodePiece.BOTH)return t+\" \"+e+\"=aTime;\\n\"},O.prototype.getCode=function(t){var e=t.out_var,n=t.out_type,o=t.scope,i=t.hasOwnProperty(\"order\")?t.order:Number.MAX_VALUE,s=new CodePiece(i);s.setBody(this.getVertexCode(n,e,o)),s.setIncludesFromMap(this.includes);var r=new CodePiece(i);return r.setBody(this.getFragmentCode(n,e,o)),r.setIncludesFromMap(this.includes),new ShaderCode(s,r,e)}},function(t,e){subgraph={gcanvas:null,graph:null,graph_gl:null,init:function(){this.graph=new LGraph},changeCanvas:function(){var t=$(\"#layout_main_layout_panel_main div.w2ui-panel-content\"),e=t.height(),n=t.width();this.graph_gl||(this.graph_gl=GL.create({width:n,height:e-20,alpha:!1}),this.graph_gl.canvas.id=\"subgraph\"),this.gcanvas&&this.gcanvas.stopRendering();var o=\"<canvas id='SubGraph' class='graph' width='\"+n+\"' height='\"+e+\"'></canvas>\";t.append(o),this.gcanvas=new LGraphCanvas(document.getElementById(\"SubGraph\"),this.graph),this.gcanvas.background_image=\"img/grid.png\",this.gcanvas.onClearRect=function(){gl.clearColor(.2,.2,.2,1),gl.clear(gl.COLOR_BUFFER_BIT)},this.gcanvas.onNodeSelected=function(t){vik.ui.updateLeftPanel(t)},this.gcanvas.onDropFile=function(t,e,n){if(\"json\"==LGraphCanvas.getFileExtension(e)){var o=JSON.parse(t);this.graph.configure(o),main_node.mesh=o.mesh,vik.ui.reset()}}}}}]);","extractedComments":["//!output.type ||  //generic output","//!node.inputs[target_slot].type || //generic input","//!collapsed"]}